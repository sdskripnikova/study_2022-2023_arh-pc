define("feast-tpl!app/feast-tpl!ui-block/layer-explorer-to-cloud/layer-explorer-to-cloud.html",["feast"],function(a){return a.smartParse('<div qa:id="layer-explorer-to-cloud">\n\t<b:layer name="explorer"\n\t\t\t remit:close="layer:close"\n\t\t\t close\n\t\t\t standard>\n\n\t\t<fn:match name="content">\n\t\t\t<b:explorer id="b-explorer"\n\t\t\t\t\t\tslim="{attrs.slim}"\n\t\t\t\t\t\ttype="{attrs.type}"\n\t\t\t\t\t\tattachments="{attrs.attachments}"\n\t\t\t\t\t\tuse:mediator="layout-manager"\n\t\t\t\t\t\tremit:cancel="cancel"\n\t\t\t\t\t\tremit:loaded="explorer:loaded"/>\n\t\t</fn:match>\n\n\t\t<fn:match name="footer">\n\t\t\t<div bem:elem="footer-button">\n\t\t\t\t<b:button2\n\t\t\t\t\tremit:click="save"\n\t\t\t\t\tqa:id="submit"\n\t\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\t\tprimary\n\t\t\t\t\tsize="m"\n\t\t\t\t\ttext="{i18n(\'Сохранить\')}"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div bem:elem="footer-button">\n\t\t\t\t<b:button2\n\t\t\t\t\tremit:click="cancel"\n\t\t\t\t\tqa:id="cancel"\n\t\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\t\tsize="m"\n\t\t\t\t\ttext="{i18n(\'Отменить\')}"\n\t\t\t\t/>\n\t\t\t</div>\n\n\t\t\t<div bem:elem="footer-button" bem:mod="right">\n\t\t\t\t<b:button2\n\t\t\t\t\tremit:click="create-folder"\n\t\t\t\t\tqa:id="create-folder"\n\t\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\t\tsize="m"\n\t\t\t\t\ttext="{i18n(\'Новая папка\')}"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</fn:match>\n\t</b:layer>\n</div>\n',"app/feast-tpl!ui-block/layer-explorer-to-cloud/layer-explorer-to-cloud.html")});define("feast-tpl!ui-block/layer-explorer-to-cloud/layer-explorer-to-cloud.html",["feast-tpl!app/feast-tpl!ui-block/layer-explorer-to-cloud/layer-explorer-to-cloud.html"],function(a){return a});define("mail/actions/AddToCloud",function(require){"use strict";var a=require("Action"),b=require("mail/Attachment");var c=require("mail/actions/AddAttachToCloud");var d=require("mail/actions/AddCloudStockToCloud");var e=a.extend({prepare:function(a){var b={folder:a.folder,need_real_filename:a.need_real_filename||false};b.ids=a.attachments.filter(function(a){return!a.isCloudStock()}).map(function(b){return a.message.getAttachmentPartID(b)});b.cloudStockFiles=a.attachments.filter(function(a){return a.isCloudStock()}).map(function(a){var b=a.id.split(":");return{bundle_id:b[0],file_id:b[1]}});return b},operation:function(a){var b=[];if(a.ids.length){b.push(c.execute({folder:a.folder,need_real_filename:a.need_real_filename,ids:a.ids}))}else{b.push(Promise.resolve())}if(a.cloudStockFiles.length){b.push(d.execute({folder:a.folder,files:a.cloudStockFiles}))}return Promise.all(b).then(function(a){var b=[];if(a[0]){b=b.concat(a[0].result.body)}a[1]&&a[1].result.body.forEach(function(a){b=b.concat(a)});return Promise.resolve(b)}).catch(function(a){return Promise.reject(a.error)})}});a.register("mail.AddToCloud",e);e.version="0.1.0";return e});define("feast-tpl!app/feast-tpl!ui-block/explorer/explorer.html",["feast"],function(a){return a.smartParse('<div>\n\t<bem:mod name="loading" test="attrs.loading"/>\n\t<bem:mod name="slim" test="attrs.slim"/>\n\t<bem:mod name="{attrs.type}" test="attrs.type"/>\n\n\t<div ref="explorer">\n\t\t\x3c!-- DON\'T REMOVE: <toolkit:b-explorer/> --\x3e\n\t</div>\n</div>\n',"app/feast-tpl!ui-block/explorer/explorer.html")});define("feast-tpl!ui-block/explorer/explorer.html",["feast-tpl!app/feast-tpl!ui-block/explorer/explorer.html"],function(a){return a});define("mrg-explorer/b-filelabel/b-filelabel",function(require){"use strict";require("toolkit/b-checkbox/b-checkbox");var a=require("toolkit/b-toolkit/b-toolkit");return a.create("b-filelabel",{_getCheckbox:function(){return this.$(".b-checkbox").getBlock()},setSelected:function(a){var b=this._getCheckbox();if(b){b.toggle(a)}else{this.$(".b-checkbox").toggleMod("checked",a)}this.data.selected=a;this.$el.toggleMod("selected",a)},setDisabled:function(a){(this._getCheckbox()||this.$(".b-checkbox")).toggleMod("disabled",a);this.toggleMod("disabled",a)}})});define("mrg-explorer/filelist/filelist",["toolkit/b-list/b-list","toolkit/b-thumb/b-thumb","mrg-explorer/b-filelabel/b-filelabel"],function(){"use strict";function a(a,b){this._list=a.getBlock();this._list.on("render",this._fileListOnRender.bind(this));this._checkboxClick=b.checkboxClick;this._itemClick=b.itemClick;this._viewMode=b.viewMode;this._items=[];this._$scroll=b.$scroll||a.parent();this._scrollEvent=this._scrollEvent.bind(this);this._$empty=b.$empty;this._onScroll=b.onscroll;this._onCacheScroll=b._onCacheScroll;this._$scroll.on("scroll",this._scrollEventLocalCache.bind(this))}a.prototype={_fileListOnRender:function(a){var b=a.target;b.blocks=b.initInner();this._list.$list.on("tap",".b-thumb, .b-filelabel",this._onItemClick.bind(this));this._findItems();this._setTitleTips()},_CHANK_LIMIT:16,_onItemClick:function(a){a.preventDefault();this._itemClick(a.currentTarget)},_scrollEventLocalCache:function(){if(this._items.length>=this._data.length){return}var a=this._$scroll[0],b=a.offsetHeight,c=a.scrollHeight;if(c>b&&c-b-this._$scroll[0].scrollTop<30){this._onCacheScroll&&this._onCacheScroll(this._data.slice(this._items.length,this._items.length+this._CHANK_LIMIT))}},enableLoadScroll:function(){this.disableLoadScroll();this._$scroll.on("scroll",this._scrollEvent)},disableLoadScroll:function(){this._$scroll.off("scroll",this._scrollEvent)},_scrollEvent:function(){if(this._items.length<this._data.length){return}var a=this._$scroll[0],b=a.offsetHeight,c=a.scrollHeight;if(c>b&&c-b-this._$scroll[0].scrollTop<30){this.disableLoadScroll();this._onScroll&&this._onScroll()}},_findItems:function(){this._items=[];this._list.$list.children().each(function(a,b){this._items.push($(b).getBlock())}.bind(this))},_setTitleTips:function(){if(this._viewMode!=="thumb"){return}for(var a=this._items.length-1;a>=0;a--){if(this._items[a].data.text.length>12){this._items[a].$el.prop("title",this._items[a].data.text)}}},_getItem:function(a){for(var b=this._items.length-1;b>=0;b--){if(this._items[b].data.id==a){return this._items[b]}}},setData:function(a){this._data=a;a=this._convertDataItemsForViewMode(a.slice(0,this._CHANK_LIMIT));this._list.setData(a).render();this._renderEpmty();this._updateDisabledItems(a.items);return this},appendItems:function(a){a=this._convertDataItemsForViewMode(a);this._list.appendItems(a.items);var b=this._list.$list.children();for(var c=b.length-a.items.length;c<b.length;c++){this._items.push($(b[c]).getBlock())}this._setTitleTips();this._updateDisabledItems(a.items);return this},getCount:function(){return this._items.length},_renderEpmty:function(){if(this._items.length){this._$empty.hide()}else{this._$empty.show()}},clear:function(){this._items=[];this._data=[];this._$empty.hide();this._list.$el.empty()},_convertDataItemsForViewMode:function(a){var b=[],c=["easy"],d,e;switch(this._viewMode){case"thumb":c.push("explorer-thumblist");for(d=0;d<a.length;d++){e={basename:a[d].text,icon:a[d].type,block:"b-thumb",src:a[d].src,ctrl:a[d].selectable,type:a[d].src?"image":a[d].type,timestamp:a[d].timestamp,size:a[d].size,id:a[d].id,text:a[d].text,selectable:a[d].selectable,selected:a[d].selected,alwaysDisabled:a[d].alwaysDisabled,mods:[]};if(e.size!==undefined&&a[d].humanSize){e.controls={bottom:{left:{items:[a[d].humanSize]}}}}b.push(e)}break;case"filelabel":c.push("explorer-labellist");for(d=0;d<a.length;d++){b.push({info:a[d].humanSize,icon:a[d].type,block:"b-filelabel",ctrl:a[d].selectable,text:a[d].text,size:a[d].size,timestamp:a[d].timestamp,type:a[d].type,id:a[d].id,selectable:a[d].selectable,selected:a[d].selected,alwaysDisabled:a[d].alwaysDisabled,mods:[]})}break;case"contactlabel":c.push("explorer-labellist");for(d=0;d<a.length;d++){b.push({info:a[d].value,src:a[d].src,block:"b-filelabel",ctrl:a[d].selectable,text:a[d].text,type:a[d].type,id:a[d].id,selectable:a[d].selectable,selected:a[d].selected,alwaysDisabled:a[d].alwaysDisabled,mods:["contacts"]})}break}return{mods:c,items:b}},_updateDisabledItems:function(a){for(var b=0;b<a.length;b++){if(a[b].alwaysDisabled){this.setItemDisabled(a[b].id,true)}}},setItemDisabled:function(a,b){var c=this._getItem(a);if(c.data.disabled==b){return}c.setDisabled(b);c.data.disabled=b;return this},setItemSelected:function(a,b){var c=this._getItem(a);if(c.data.selected==b){return}c.setSelected(b);c.setDisabled(false);return this},isAllItemsChecked:function(){var a=false;for(var b=this._items.length-1;b>=0;b--){if(this._items[b].data.selectable&&!this._items[b].data.disabled){a=true;if(!this._items[b].data.selected){return false}}}return a},hasSelectedItem:function(){for(var a=this._items.length-1;a>=0;a--){if(this._items[a].data.selected){return true}}return false},hasSelectableItems:function(){for(var a=this._items.length-1;a>=0;a--){if(this._items[a].data.selectable&&!this._items[a].data.disabled){return true}}return false},setViewMode:function(a){this._viewMode=a},renderFreeSpace:function(a){var b;for(var c=this._items.length-1;c>=0;c--){b=this._items[c];if(b.data.selected||!b.data.selectable||b.data.alwaysDisabled){continue}b.data.disabled=+b.data.size>a;b.setDisabled(b.data.disabled)}},disableUnselected:function(){var a;for(var b=this._items.length-1;b>=0;b--){a=this._items[b];if(a.data.selected||!a.data.selectable){continue}if(a.data.disabled){continue}a.data.disabled=true;a.setDisabled(true)}},enableUnselected:function(){var a;for(var b=this._items.length-1;b>=0;b--){a=this._items[b];if(a.data.selected||!a.data.selectable){continue}if(!a.data.disabled){continue}if(a.data.alwaysDisabled){continue}a.data.disabled=false;a.setDisabled(false)}},scrollToTop:function(){this._$scroll.prop("scrollTop",0)}};return a});define("toolkit/b-tree/b-tree",["jquery","toolkit/b-toolkit/b-toolkit"],function($,a){"use strict";return a.create("b-tree",{animation:300,showDelay:500,hideDelay:500,_onTap:function(a){var b=a.currentTarget,c=$(b).attr("data-name");this.emit(c,{evt:a,el:b,animation:this.animation})},onRender:function(){this.$el.on("mouseenter mouseleave",".js-href",function(b){var c=b.type==="mouseenter",d=$(b.currentTarget);a.toggleMod(d,"hover",c);this.hoverId=c?d.attr("data-id"):"null"}.bind(this));this.$el.on("tap",".b-tree__item__folding",this._onTap.bind(this));this.$el.on("tap","[data-id]",function(a){this.emit("click",{id:$(a.currentTarget).attr("data-id")})}.bind(this))},setActiveItem:function(a){this.$("__item_active").toggleMod("active",false);this.$el.find('[data-id="'+a+'"]').toggleMod("active",true);this.data.activeId=a;return this},_getFoldingRoot:function(a){var b=a.parents(".b-tree__subitems"),c=b.eq(b.length-1).prev();return c.length?c:a},onToggleFolding:function(a,b){b.evt.preventDefault();b.evt.stopPropagation();this.toggleFolding($(b.el).parents(".b-tree__item"),b.animation,b.save)},toggleFolding:function(b,c){var d=b.find(".b-tree__item__folding__arrow"),e=b.attr("data-id"),f=this.$('[data-parent="'+e+'"]'),g=a.getMods(d).open;c=c>=0?c:this.animation;var h={$el:b,el:b.get(0),widget:this};f.stop(true,true);this.emit("redraw",h);f.slideToggle(c,function(){this.emit("redraw",h)}.bind(this));this.emit("change-foldings-state",{open:!g,arrow:d,items:f,id:e,item:b});b.attr("data-folding",!g?"open":"close");a.toggleMod(d,"open",!g)},getItemElem:function(a){return this.$('.b-tree__item[data-id="'+a+'"]')},renderItemsEllipsisTitle:function(){this.$(".b-tree__item__text").each(function(){if(this.title===""&&this.scrollWidth>this.offsetWidth){this.title=this.textContent||this.innerText||this.innerHTML}})},moveLongTrees:function(){}})});define("mrg-explorer/utils/utils",function(){"use strict";var a={regRusE:/ё/gi};return{fixSpecialSymbols:function(){var a=document.createElement("textarea");return function(b){try{a.innerHTML=b;return a.value}catch(a){return b}}}(),sortItems:function(a,b,c){if(!Array.isArray(b)){b=[b]}a.sort(this._sort.bind(b));if(c){a.reverse()}return a},_sort:function(b,c){var d=this,e;if(b.type==="folder"&&c.type!=="folder"){return-1}if(b.type!=="folder"&&c.type==="folder"){return 1}for(var f=0;f<d.length;f++){e=d[f];if(typeof e!=="string"||e===""){continue}if(typeof b[e]==="number"&&typeof c[e]==="number"){if(b[e]<c[e]){return-1}if(b[e]>c[e]){return 1}continue}if(typeof b[e]==="boolean"||typeof c[e]==="boolean"){if(b[e]&&!c[e]){return-1}if(!b[e]&&c[e]){return 1}continue}try{b=b[e].toLowerCase().replace(a.regRusE,"е");c=c[e].toLowerCase().replace(a.regRusE,"е")}catch(a){continue}if(b>c){return 1}if(b<c){return-1}}return 0},isEqual:function(a,b){var c,d,e;if(!a||!b){return a===b}c=Object.keys(a);d=Object.keys(b);if(a.toString()!==b.toString()){return false}for(e=c.length-1;e>=0;e--){if(a[c[e]]!==b[d[e]]){return false}}return true}}});define("mrg-explorer/navigate/navigate",["toolkit/b-tree/b-tree","mrg-explorer/utils/utils"],function(a,b){"use strict";function c(a,b){this._tree=a.getBlock();this._tree.on("click",b.onClick);this._tree.onChangeFoldingsState=b.onFolding;this._name=b.name;this._rootID=b.rootID;this._label=b.label;this._treeID=a.attr("data-id");this._$scroll=a.parent();this._onScroll=b.onScroll;this._scrollEvent=this._scrollEvent.bind(this)}c.prototype={enableLoadScroll:function(){this.disableLoadScroll();this._$scroll.on("scroll",this._scrollEvent)},disableLoadScroll:function(){this._$scroll.off("scroll",this._scrollEvent)},_scrollEvent:function(){var a=this._$scroll[0],b=a.offsetHeight,c=a.scrollHeight;if(c>b&&c-b-this._$scroll[0].scrollTop<30){this.disableLoadScroll();this._onScroll&&this._onScroll()}},setData:function(a){var b;var c=this._tree.getMods();a=this._convertDataForViewTree(a);if(this._name==null){b=a}else{b=[{group:{id:this._rootID,name:this._name,label:this._label},id:this._rootID,items:a}]}b={activeId:this._rootID,id:this._treeID,items:b,mods:Object.keys(c)};this._tree.setData(b).render();this._dataItems=a;this.renderLongTrees();return this},setSortMode:function(a,b){this._currentSortFiled=a;this._isSortReverse=b},setActiveItem:function(a){this._tree.setActiveItem(a)},_convertDataForViewTree:function(a){if(!a){return}var c;if(Array.isArray(a)){c=[];for(var d=0;d<a.length;d++){if(a[d].type!=="folder"){continue}c.push(this._convertDataForViewTree(a[d]))}if(this._currentSortFiled){b.sortItems(c,this._currentSortFiled,this._isSortReverse)}}else{c={id:a.id,icon:a.icon?a.icon:"ico_system_folder",hover:true,name:a.id,text:a.text};if(this._hasSubfolder(a)){c.folding=a._expanded?"open":"close"}c.items=this._convertDataForViewTree(a.items)}return c},_hasSubfolder:function(a){return a.count&&!!a.count.folders},setExpanded:function(a){var b=this._tree.$('[data-id="'+a+'"][data-folding="close"]');if(!b.length){return}this._tree.toggleFolding(b);this.renderLongTrees()},setGroupLabel:function(){},isSplitedTree:function(a){return!!this._tree.$('[data-id="'+a+'"]').attr("data-moved")},renderLongTrees:function(){this._tree.moveLongTrees(this._dataItems);this._tree.renderItemsEllipsisTitle()}};return c});define("mrg-explorer/model-manager/model-manager",["jquery","mrg-explorer/utils/utils"],function($,a){"use strict";function b(a){$.extend(this,this.defaults,a)}b.prototype={defaults:{rootID:"/",loadLimit:20,modelConvertor:function(a){return $.extend({},a)},findIDParams:function(a){return{id:a}},searchQueryParams:function(a,b){return{name_needle:a}},addSortParams:function(a,b,c){return a},hasServerSort:false,enableClientSort:false,enableSearch:false,localSearch:false,localSearchFields:["text"],rootTitle:null,defaultID:null,hideFolders:false,sortNavigate:false,needLicenseAgree:false,acceptLicense:function(){return new Promise(function(a,b){a()})},openSecureFolder:function(a,b){return new Promise(function(a,b){a("ico_system_menu")})}},find:function(a,b){var c=$.Deferred(),d=this.findIDParams(a);b=b||{};if(this.loadLimit){d.limit=this.loadLimit+1;d.offset=b.offset||0}if(this.hasServerSort){this.addSortParams(d,b.sortField,b.sortReverse)}this.model.find(d).then(function(a){if(this.model&&this.model.all){a.parentCount=this.model.all.length}c.resolve(this._convertData(a))}.bind(this),c.reject);return c.promise()},search:function(a,b){var c=$.Deferred(),d=this.searchQueryParams(a,b);b=b||{};if(this.loadLimit){d.limit=this.loadLimit+1;d.offset=b.offset||0}if(this.hasServerSort){this.addSortParams(d,b.sortField,b.sortReverse)}this.model.find(d).then(function(a){c.resolve(this._convertData(a))}.bind(this));return c.promise()},_convertData:function(b){var c={folders:[],files:[],parentCount:b.parentCount},d;for(var e=0;e<b.length;e++){d=this.modelConvertor(b[e]);d._originalData=b[e];if(d.text){d.text=a.fixSpecialSymbols(d.text)}if(d.type==="folder"){c.folders.push(d)}else{c.files.push(d)}}return c}};return b});define("mrg-explorer/sortmenu/sortmenu",["toolkit/b-dropdown/b-dropdown","toolkit/b-controls-group/b-controls-group"],function(){"use strict";function a(a,b){this._dropdown=a.getBlock();this.setActiveItem(b.activeID||this._dropdown.$list.find("[data-id]").attr("data-id"));this._onClick=b.click;this._dropdown.on("click",this._onClickItem.bind(this));this._isReversed=false}a.prototype={_onClickItem:function(a,b){var c=$(b.currentTarget).attr("data-id");if(this.getActiveID()==c){this.toggleReverseMode()}else{this.setActiveItem(c)}this._onClick&&this._onClick(c,this.isReversed())},setReverseMode:function(a){if(a){this._dropdown.$(".ico_sort").toggleMod("sort_up",true).toggleMod("sort_down",false)}else{this._dropdown.$(".ico_sort").toggleMod("sort_up",false).toggleMod("sort_down",true)}this._isReversed=a},toggleReverseMode:function(){this.setReverseMode(!this.isReversed())},getActiveID:function(){return this._activeID},isReversed:function(){return this._isReversed},setActiveItem:function(a){this._activeID=a;this._dropdown.setActiveItem(a)},setDisabled:function(){this._dropdown.toggleMod("disabled",true)},setEnabled:function(){this._dropdown.toggleMod("disabled",false)}};return a});define("toolkit/b-input/b-input",["toolkit/b-toolkit/b-toolkit"],function(a){"use strict";var b={space:32};var c="b-input_error";return a.create("b-input",{init:function(){var a=this.getData().prevent||[];this._previousVal="";a=a.map(function(a){return b[a]||a});this.$el.on("change input",function(){this._emitChange()}.bind(this));this.$el.on("focus",function(){this.emit("focus",this.$el.val())}.bind(this));this.$el.on("blur",function(){this.emit("blur")}.bind(this));this.$el.on("keydown",function(b){if(a.includes(b.which)){return false}return true}.bind(this));this.$el.on("keyup",function(){this._emitChange()}.bind(this))},_emitChange:function(){var a=this.$el.val();if(this._previousVal!==a){this._previousVal=a;this.emit("change",a)}},getValue:function(){return this.$el.val()},setValue:function(a){var b,c;try{b=this.el.selectionStart;c=this.el.selectionEnd}catch(a){}this.$el.val(a);if(b!==void 0&&c!==void 0&&document.activeElement===this.$el[0]){if(this.hasMod("save-zero-position")){if(b===0&&c===0){try{this.el.setSelectionRange(b,c)}catch(a){}}}}},focus:function(){var a=this.getValue(),b=a.length,c=this.$el.get(0);this.$el.focus();if(c.setSelectionRange){c.setSelectionRange(b,b)}},previousValidateValue:void 0,validate:function(a){this.previousValidateValue=this.getValue();return a(this.$el,this.getValue())},toggleError:function(a){if(a){this.$el.removeClass(c)}else{this.$el.addClass(c)}}})});define("mrg-explorer/b-search/b-search",["toolkit/b-toolkit/b-toolkit","toolkit/b-input/b-input"],function(a){"use strict";return a.create("b-search",{init:function(){this._initEvents()},onRender:function(){this._initEvents()},_initEvents:function(){this.initInner();this._input=this.$(".b-input").getBlock();this._$form=this.$("form");this._$form.on("submit",function(a){a.preventDefault();if(this.hasMod("disabled")){return}this.emit("submit",{value:this._input.$el.val()})}.bind(this));this._$form.find(".ico").on("click",function(){this._$form.submit()}.bind(this));this._input.on("change",function(a,b){this.emit("change",b)}.bind(this));this._input.on("focus",function(a,b){this.toggleMod("focus",true)}.bind(this));this._input.on("blur",function(a,b){this.toggleMod("focus",false)}.bind(this))},setDisabled:function(){this.toggleMod("disabled",true);this._input.$el.prop("disabled",true)},setEnabled:function(){this.toggleMod("disabled",false);this._input.$el.prop("disabled",false)},getValue:function(){return this._input.$el.val()},setValue:function(a){this._input.$el.val(a)},resetSuggest:function(){if(document.activeElement!==this._input.$el[0]){return}this._input.$el.blur().focus()}})});define("mrg-explorer/b-explorer-password/b-explorer-password",["toolkit/b-toolkit/b-toolkit","toolkit/b-input/b-input"],function(a){"use strict";return a.create("b-explorer-password",{init:function(){this._initEvents()},onRender:function(){this._initEvents()},_initEvents:function(){this.initInner();this._$form=this.$("form");this._input=this._$form.find(".b-input").getBlock();this._$link=this.$(".b-explorer-password__link");this._$form.on("submit",function(a){a.preventDefault();if(this._disabled){return}this.emit("submit",{value:this._input.$el.val()})}.bind(this));this._$error=this.$(".b-explorer-password__block_error")},setDisabled:function(){this._disabled=true},setEnabled:function(){this._disabled=false;this.focus();this.clearValue()},showError:function(a){this._$error.html(a).show();this._input.toggleMod("error",true);this.clearValue();this.focus()},hideError:function(){this._$error.hide();this._input.toggleMod("error",false)},clearValue:function(){this._input.$el.val("")},setLinkID:function(a){this._$link.prop("href",this.data.restoreURL.replace(/{id}/g,a))},focus:function(){this._input.$el.focus()}})});define("mrg-explorer/b-explorer-license/b-explorer-license",["toolkit/b-toolkit/b-toolkit"],function(a){"use strict";return a.create("b-explorer-license",{init:function(){this._initEvents()},onRender:function(){this._initEvents()},_initEvents:function(){this.$(".btn").click(this.emit.bind(this,"agree"))},show:function(){this.$el.show()},hide:function(){this.$el.hide()}})});define("mrg-explorer/b-explorer/b-explorer",["jquery","features","toolkit/b-toolkit/b-toolkit","mrg-explorer/filelist/filelist","mrg-explorer/navigate/navigate","mrg-explorer/model-manager/model-manager","mrg-explorer/sortmenu/sortmenu","mrg-explorer/utils/utils","toolkit/b-checkbox/b-checkbox","mrg-explorer/b-search/b-search","mrg-explorer/b-explorer-password/b-explorer-password","mrg-explorer/b-explorer-license/b-explorer-license","toolkit/btn/btn"],function($,a,b,c,d,e,f,g){"use strict";return b.create("b-explorer",{init:function(){this._models={};this._requestID=0;this._openSecureFolderRequestID=0;this._searchFolder={items:[]};this._selectedItems={};for(var a=0;a<this.data.modelsList.length;a++){this._selectedItems[this.data.modelsList[a]]={}}this._viewListData=[]},setFreeSpace:function(a){this._totalSpace=+a;this._freeSpaceLimited=true;this._updateViewListFreeSpace()},setMaxSelectedCount:function(a){this._maxSelected=a;this._selectedCountLimited=true},_hasFreeSelectedCount:function(){if(!this._selectedCountLimited){return true}return this._maxSelected-this.getSelectedCount()>0},initModel:function(a,b){var c=new e(a);this._addModel(c);if(!b){this._setCurrentModel(c.id)}return this._initModel(c,b)},_initModel:function(a,b){this._toggleSpinner(true);return a.find(a.rootID,{sortField:this._currentSortFiled,sortReverse:this._isSortReverse}).then(function(c){var d;this._toggleSpinner(false);this._setViewData({id:a.rootID,type:"folder",text:a.rootTitle,items:c.folders.concat(c.files)},a.id);var d=c.files.length;if(!a.hideFolders){d+=c.folders.length}this._checkPagination(a.id,a.rootID,d);if(b){return}this._activeFolder=null;if(a.defaultID==null){this.setActiveFolder(this._getCurrentModel().rootID);return}for(var e=c.folders.length-1;e>=0;e--){if(c.folders[e].id==a.defaultID){this.setActiveFolder(a.defaultID);return}}this.setActiveFolder(this._getCurrentModel().rootID);return c}.bind(this),function(b){this._toggleSpinner(false);if(b.status===424){a.needLicenseAgree=true;this._activeFolder=null;this._setViewData({id:a.rootID,type:"folder",text:a.rootTitle,items:[]},a.id);this.setActiveFolder(a.rootID)}return b}.bind(this))},_checkPagination:function(a,b,c){var d=this._models[a],e;if(!d.loadLimit){return}e=this._getDataItemById(b,d.formatedData);e._hasPaginate=c>d.loadLimit},_setCurrentModel:function(a){if(this._activeModelID==a){return}var b=this._models[a],c;this._activeFolder=null;this._activeModelID=a;if(this.itemSearch){if(b.enableSearch){this.itemSearch.setEnabled()}else{this.itemSearch.setDisabled()}}if(this.itemSortMenu){if(b.hasServerSort||b.enableClientSort){this.itemSortMenu.setEnabled()}else{this.itemSortMenu.setDisabled()}}if(this._modeButtons){this._modeButtons.forEach(function(a){a.toggle(true)})}c=this.$el.is("."+this.bemName)?this.$el:this.$("."+this.bemName);Object.keys(this._models).forEach(function(b){c.toggleMod(b,b==a)},this)},_getCurrentModel:function(){return this._models[this._activeModelID]},_addModel:function(a){this._models[a.id]=a;this._addNavigate(a)},_getModelItem:function(a,b){var c={offset:b||0,sortField:this._currentSortFiled,sortReverse:this._isSortReverse};return this._getCurrentModel().find(a,c)},setDefaultSelected:function(a){this._defaultSelected=a},_checkDefaultSelected:function(a){if(!this._defaultSelected){return}var b=this._defaultSelected[this._getCurrentModel().id];if(!b){return}for(var c=b.length-1;c>=0;c--){if(b[c].id==a.id){b.splice(c,1);a.selected=true;this._updateSelectedList(a);break}}},_getDefaultSelectedSize:function(){if(!this._defaultSelected){return 0}var a=0,b;Object.keys(this._defaultSelected).forEach(function(c){this._defaultSelected[c].forEach(function(c){b=+c.size;if(b){a+=b}},this)},this);return a},_isModelWithUnlimitedSpace:function(a){var b=this._models[a];if(!b){b=this._getCurrentModel()}return b&&b.unlimitedSpace},_getDefaultSelectedCount:function(){if(!this._defaultSelected){return 0}var a=0;Object.keys(this._defaultSelected).forEach(function(b){a+=this._defaultSelected[b].length},this);return a},getSelected:function(){var a={};for(var b in this._selectedItems){if(!this._selectedItems.hasOwnProperty(b)){continue}a[b]=[];for(var c in this._selectedItems[b]){if(!this._selectedItems[b].hasOwnProperty(c)){continue}a[b].push(this._selectedItems[b][c]._originalData)}}return a},getActiveFolderId:function(){return this._activeFolder},getUloadedDefaultSelected:function(){var a={};for(var b in this._defaultSelected){if(!this._defaultSelected.hasOwnProperty(b)){continue}a[b]=[];for(var c in this._defaultSelected[b]){if(!this._defaultSelected[b].hasOwnProperty(c)){continue}a[b].push(this._defaultSelected[b][c].id)}}return a},onRender:function(){this.$el=this.$el.is("."+this.bemName)?this.$el:this.$("."+this.bemName);this.viewMode=this.data.defaultViewMode||this.data.viewMods[0];this._initComponents();this._setScrollPrevent();if(this.data.defaultSelected){this.setDefaultSelected(this.data.defaultSelected)}if(this.data.selectLimit){this.setMaxSelectedCount(this.data.selectLimit)}if(this.data.isMocka&&this.data&&this.data.items){if(!window.explorer){window.explorer=this}if("freeSpace"in this.data){this.setFreeSpace(this.data.freeSpace)}for(var a=0;a<this.data.modelsList.length;a++){var b=this.data.modelsList[a],c=new e({model:this.data.items[b],id:b,rootTitle:this.data.items[b].text});c.formatedData=this.data.items[b];c.hideFolders=!!this.data.items[b].hideFolders;this._addModel(c);this._setViewData(c.formatedData,c.id)}this._setCurrentModel(this.data.modelsList[0]);this.setActiveFolder(this._getCurrentModel().rootID)}},_setScrollPrevent:function(){this.$(".b-explorer__block__right, .b-explorer__block__left").on("wheel mousewheel",this._eventMouseWheel)},_eventMouseWheel:function(a){if("deltaY"in a.originalEvent&&a.originalEvent.deltaY===0){return}if(this.scrollHeight==this.offsetHeight){a.preventDefault();a.stopPropagation();return}var b;if("deltaY"in a.originalEvent){b=a.originalEvent.deltaY<0}else{b=a.originalEvent.wheelDelta>0}if(!b&&this.scrollTop>=this.scrollHeight-this.offsetHeight||b&&!this.scrollTop){a.preventDefault();a.stopPropagation()}},_initComponents:function(){this.initInner();this._initComponentTree();this._initComponentSearch();this._initComponentSort();this._initComponentFileList();this._initComponentViewModes();this._initComponentPasswordForm();this._initComponentLicense();this._initCheckbox()},_initComponentViewModes:function(){if(this.data.viewMods.length<2){return}this._modeButtons=[];var a=this.$(".b-explorer-header__item_viewmode"),c=this,d;for(var e=0;e<this.data.viewMods.length;e++){d=a.find('[data-id="'+this.data.viewMods[e]+'"]').getBlock();this._modeButtons.push(d);if(this.viewMode==this.data.viewMods[e]){d.toggleMod("active",true)}}a.on("click","[data-id]",function(){if(!b.hasMod(this,"disabled")){c.setViewMode($(this).attr("data-id"))}})},_initComponentPasswordForm:function(){this._itemPasswordForm=this.$(".b-explorer-password").getBlock();if(!this._itemPasswordForm){return}this._itemPasswordForm.on("submit",function(a,b){if(b.value===""){this._itemPasswordForm.showError(this.data.password.emptyPassword);return}this._openSecureFolder(this._activeFolder,b.value)}.bind(this))},_initComponentLicense:function(){this._itemLicense=this.$(".b-explorer-license").getBlock();if(!this._itemLicense){return}this._itemLicense.on("agree",function(){var a=this._getCurrentModel();a.acceptLicense().then(function(){this.onLicenseAccept()}.bind(this))}.bind(this))},onLicenseAccept:function(){var a=this._getCurrentModel();a.needLicenseAgree=false;this._initModel(a);this._activeModelID=null;this._setCurrentModel(a.id)},_initCheckbox:function(){this.itemCheckboxCheckAll=this.$(".b-explorer-header__item_checkbox .b-checkbox").getBlock();if(!this.itemCheckboxCheckAll){return}this.itemCheckboxCheckAll.on("change",function(){this._isCheckedAllByUser=!this.itemList.hasSelectedItem();this._toggleCheckAllItems(this._isCheckedAllByUser);this.emit("checkall",{checked:this.itemCheckboxCheckAll.data.checked})}.bind(this))},_initComponentSearch:function(){this.itemSearch=this.$(".b-search").getBlock();if(!this.itemSearch){return}this.itemSearch.on("submit",function(a,b){if(b.value===""){this.setActiveFolder(this._activeFolder);return}var c=b.value.toLowerCase();if(c===this._currentSearchQuery){return}this._setSearchQuery(c);this._search();this.itemSearch.resetSuggest();try{this.emit("search",{value:b.value,modelID:this._getCurrentModel().id})}catch(a){}}.bind(this));this.itemSearch.on("change",function(a,b){var c=this._getCurrentModel();if(!c.localSearch){return}var b=b.toLowerCase().replace(/ё/g,"е");if(b===this._currentSearchQuery){return}if(b===""){this.setActiveFolder(this._activeFolder);clearTimeout(this._searchOnKeyTimer);return}this._setSearchQuery(b);this._localSearch();clearTimeout(this._searchOnKeyTimer);this._searchOnKeyTimer=setTimeout(function(){try{this.emit("search",{value:b,modelID:c.id})}catch(a){}}.bind(this),1e3)}.bind(this))},_initComponentSort:function(){this._currentSortFiled=this.data.defaultSort;if(!this.data.sortItems||!this.data.sortItems.length){return}if(!this._currentSortFiled){this._currentSortFiled=this.data.sortItems[0].field}this.itemSortMenu=new f(this.$(".b-explorer-header__item_sort .b-dropdown"),{click:function(a,b){this._resortItems(a,b);this.emit("sort",{id:a,reversed:b})}.bind(this),activeID:this._currentSortFiled})},_initComponentTree:function(){this._itemsTree={}},_addNavigate:function(a){var b=this.$(".b-tree[data-id="+a.id+"]");this._itemsTree[a.id]=new d(b,{onScroll:this._paginateOnScroll.bind(this),onClick:function(b,c){if(c.id==this._activeFolder&&a==this._getCurrentModel()&&!this._currentSearchQuery){return}this._setCurrentModel(a.id);this.setActiveFolder(c.id);try{this.emit("folderclick",{id:c.id,modelID:a.id})}catch(a){}}.bind(this),onFolding:function(b,c){var d=this._getDataItemById(c.id,a.formatedData);d._expanded=c.open;if(c.open){this._loadExpandTree(c.id,a.id)}}.bind(this),name:a.rootTitle,rootID:a.rootID})},_getCurrentNavigate:function(){return this._getModelNavigate(this._activeModelID)},_getModelNavigate:function(a){return this._itemsTree[a]},toggleItemSelected:function(a){var b=this._getDataItemById(a)||this._getDataItemById(a,this._searchFolder.items),c=this._hasFreeSelectedCount();if(!b.selectable){return}b.selected=!b.selected;this.itemList.setItemSelected(a,b.selected);this._updateSelectedList(b);if(c!=this._hasFreeSelectedCount()){if(c){this.itemList.disableUnselected()}else if(!this._freeSpaceLimited){this.itemList.enableUnselected()}else{this._updateViewListFreeSpace()}}else{this._updateViewListFreeSpace()}this._renderCheckAllCheckbox();return this},_getSelectedSize:function(){var a=0,b;Object.keys(this._selectedItems).forEach(function(c){Object.keys(this._selectedItems[c]).forEach(function(d){b=+this._selectedItems[c][d].size;if(b){a+=b}},this)},this);return a+this._getDefaultSelectedSize()},getSelectedCount:function(){var a=0;Object.keys(this._selectedItems).forEach(function(b){Object.keys(this._selectedItems[b]).forEach(function(c){if(this._selectedItems[b][c].selected){a++}},this)},this);return a+this._getDefaultSelectedCount()},_updateSelectedList:function(a,b){if(!b){b=this._getCurrentModel().id}if(a.selected){this._selectedItems[b][a.id]=a}else{delete this._selectedItems[b][a.id]}},_getFreeSpace:function(){return this._isModelWithUnlimitedSpace()?Infinity:this._totalSpace-this._getSelectedSize()},_initComponentFileList:function(){this._lastLazyLoadRequest=0;this.itemList=new c(this.$(".b-list"),{itemClick:function(a){var b=$(a),c=b.attr("data-id"),a;if(b.hasMod("disabled")){return}a=this._getDataItemById(c)||this._getDataItemById(c,this._searchFolder.items);if(a.type==="folder"){this._setFolderExpand(a.id,this._getCurrentModel());this.setActiveFolder(a.id);try{this.emit("folderclick",{id:a.id,modelID:this._getCurrentModel().id})}catch(a){}return}this.toggleItemSelected(c);this.emit("selectclick",{selected:!a.selected,item:a})}.bind(this),$empty:this.$(".b-explorer__empty"),viewMode:this.viewMode,onscroll:this._paginateOnScroll.bind(this),_onCacheScroll:function(a){var b=this.itemList.isAllItemsChecked()&&this._isCheckedAllByUser;var c=this._getCurrentModel();this.itemList.appendItems(a);this._checkSelectedAfterScroll(b);this.emit("cachescroll",{modelID:c.id})}.bind(this)})},_getDataItemById:function(a,b){b=b||this._getCurrentData();if(!Array.isArray(b)){b=[b]}for(var c=b.length-1;c>=0;c--){if(b[c].id==a){return b[c]}if(b[c].items&&b[c].items.length){var d=this._getDataItemById(a,b[c].items);if(d){return d}}}},setViewMode:function(a){if(a==this.viewMode){return}this.viewMode=a;this.itemList.setViewMode(a);this._renderModeButtons();if(this._secureDialogOpened){return}this._renderViewList();this.emit("view-mode-change",{viewMode:this.viewMode})},_renderModeButtons:function(){var a=this.viewMode;this._modeButtons.forEach(function(b){b.toggleActive(a==b.$el.attr("data-id"))})},_setViewData:function(a,b){var c=b?this._models[b]:this._getCurrentModel();c.formatedData=a;this._renderTree(b)},_getCurrentData:function(){return this._getCurrentModel().formatedData},_getModelData:function(a){return this._models[a].formatedData},_renderTree:function(a){var b,c,d;if(a){c=this._models[a];b=this._getModelNavigate(a);d=this._getModelData(a)}else{c=this._getCurrentModel();b=this._getCurrentNavigate();d=this._getCurrentData()}if(c.sortNavigate){b.setSortMode(this._currentSortFiled,this._isSortReverse)}b.setData(d.items)},_setFolderExpand:function(a,b){var c=this._getDataItemById(this._activeFolder),d=this._getModelNavigate(b.id);do{if(!c){break}c._expanded=true;d.setExpanded(c.id)}while((c=c._parent)&&c!=b.rootID)},_loadExpandTree:function(a,b){var c=this._models[b],d=this._getDataItemById(a,c.formatedData);if(d.items){this._getCurrentNavigate().renderLongTrees();return}c.find(a,{sortField:this._currentSortFiled,sortReverse:this._isSortReverse}).done(function(b){if(d.items){return}var e=b.files.length;if(!c.hideFolders){e+=b.folders.length}b=b.folders.concat(b.files);this._setParent(b,d);this._checkDataDublicate(b,c);d.items=b;this._checkPagination(c.id,a,e);this._renderTree(c.id)}.bind(this))},_setSearchQuery:function(a){if(a===""){this._previousSearchQuery="";this._currentSearchQuery="";this.itemSearch.setValue("");this.toggleMod("search",false)}else{this._previousSearchQuery=this._currentSearchQuery;this._currentSearchQuery=a;if(this._previousSearchQuery===""){this.toggleMod("search",true)}}this._searchFolder.items=[];this._searchFolder._hasPaginate=false},setActiveFolder:function(a){if(this._activeFolder==a&&!this._currentSearchQuery){return Promise.resolve()}if(this.itemSearch){this._setSearchQuery("")}this._closeSecureDisalog();this._closeLicenseDialog();var b=this._getDataItemById(a),c=this._getCurrentModel(),d={field:this._currentSortFiled,reverse:this._isSortReverse},e=false,f;this._activeFolder=a;if(b.secure&&!b.open){this._getCurrentNavigate().setActiveItem(b.id);this._openSecureDialog(a);return Promise.resolve()}if(c.hasServerSort&&b._lastSortParams&&(b._lastSortParams.field!=this._currentSortFiled||!!b._lastSortParams.reverse!=!!this._isSortReverse)){e=true}if(!b.items||e){f=++this._requestID;return this._getModelItem(a).done(function(g){if(f!==this._requestID){return}if(this._activeFolder!=a||c!=this._getCurrentModel()){return}if(e){b.items=null}b._expanded=true;var h=g.folders.concat(g.files);this._setParent(h,b);this._checkDataDublicate(h,c);b.items=h;if(g.parentCount){this._checkPagination(c.id,a,g.parentCount)}else{this._checkPagination(c.id,a,h.length)}if(g.folders.length||e){this._renderTree()}this._setActiveFolder(b,d)}.bind(this))}b._expanded=true;this._setActiveFolder(b,d);return Promise.resolve()},updateActiveTree:function(){var a=this._activeFolder;var b=this._getDataItemById(a);var c=this._getCurrentModel();var d;d=++this._requestID;return this._getModelItem(a).done(function(e){if(d!==this._requestID){return}if(this._activeFolder!=a||c!=this._getCurrentModel()){return}var f=e.folders.concat(e.files);this._setParent(f,b);b.items=f;this._checkPagination(c.id,a,f.length);if(e.folders.length){this._renderTree()}this._setActiveFolder(b,{field:this._currentSortFiled,reverse:this._isSortReverse})}.bind(this))},_openSecureFolder:function(a,b){this._itemPasswordForm.setDisabled();this._openSecureFolderRequestID++;var c=this._getCurrentModel().openSecureFolder(a,b),d=this._openSecureFolderRequestID;c.then(function(b){var c=this._getDataItemById(a);if(c.open){return}c.open=true;if(b){c.icon=b}c.items=null;this._activeFolder=null;this._renderTree();this.setActiveFolder(a)}.bind(this));c["catch"](function(b){if(d!==this._openSecureFolderRequestID||this._activeFolder!==a){return}this._itemPasswordForm.setEnabled();this._itemPasswordForm.showError(b)}.bind(this))},_openSecureDialog:function(a){this.toggleMod("password",true);this._itemPasswordForm.setEnabled();this._itemPasswordForm.hideError();this._itemPasswordForm.clearValue();this._itemPasswordForm.setLinkID(a);this._clearView();this._secureDialogOpened=true},_closeSecureDisalog:function(){if(!this._itemPasswordForm){return}this.toggleMod("password",false);this._itemPasswordForm.setDisabled();this._secureDialogOpened=false},_openLicenseDialog:function(){if(!this._itemLicense){this.emit("licenseopen");return}this._itemLicense.show()},_closeLicenseDialog:function(){if(!this._itemLicense){this.emit("licenseclose");return}this._itemLicense.hide()},_clearView:function(){this._viewListData=[];this.itemList.clear()},_checkDataDublicate:function(a,b){var c,d=this._selectedItems[b.id];for(var e=a.length-1;e>=0;e--){c=d[a[e].id]||this._getDataItemById(a[e].id);if(!c){if(a[e].selected){this._checkDefaultSelected(a[e],b.id);this._updateSelectedList(a[e])}continue}if(c.type==="folder"){a.splice(e,1)}else{a[e]=c}}},_setParent:function(a,b){for(var c=a.length-1;c>=0;c--){a[c]._parent=b}},_setActiveFolder:function(a,b){var c=this._getCurrentNavigate();this.setViewListData(a);a._lastSortParams=b;for(var d in this._itemsTree){if(!this._itemsTree.hasOwnProperty(d)){continue}if(this._itemsTree[d]===c){c.setActiveItem(a.id)}else{this._itemsTree[d].setActiveItem(null)}}if(this._hasFreeSelectedCount()){this._updateViewListFreeSpace()}else{this.itemList.disableUnselected()}this._updateCheckAllStatus()},setViewListData:function(a){this._viewListData=a.items||[];this._renderViewList()},_renderViewList:function(a){var b=this._getCurrentModel();if(this.ignoreRootRender){this._viewListData=[]}if(a){this._viewListData=a}if(b.hideFolders){this._viewListData=this._viewListData.filter(function(a){return a.type!=="folder"})}else{this._viewListData=this._viewListData.slice()}if(this._currentSortFiled&&b.enableClientSort){g.sortItems(this._viewListData,this._currentSortFiled,this._isSortReverse)}for(var c=this._viewListData.length-1;c>=0;c--){this._checkDefaultSelected(this._viewListData[c])}this.itemList.scrollToTop();if(!this.ignoreRootRender){this.itemList.setData(this._viewListData)}if(!this._hasFreeSelectedCount()){this.itemList.disableUnselected()}else if(!this._freeSpaceLimited){this.itemList.enableUnselected()}else{this._updateViewListFreeSpace()}if(this._currentSearchQuery){this._renderViewListPagination(this._searchFolder)}else{this._renderViewListPagination()}if(b.needLicenseAgree){this.itemList.clear();this._openLicenseDialog();this.setActiveFolder(b.rootID);if(this.itemSortMenu){this.itemSortMenu.setDisabled()}if(this._modeButtons){this._modeButtons.forEach(function(a){a.toggle(false)})}}},_renderViewListPagination:function(a){a=a||this._getDataItemById(this._activeFolder);if(a._hasPaginate){this.itemList.enableLoadScroll();Object.keys(this._itemsTree).forEach(function(a){this._itemsTree[a].enableLoadScroll()}.bind(this))}else{this.itemList.disableLoadScroll();Object.keys(this._itemsTree).forEach(function(a){this._itemsTree[a].disableLoadScroll()}.bind(this))}},_updateViewListFreeSpace:function(){if(!this._freeSpaceLimited){return}this.itemList.renderFreeSpace(this._getFreeSpace())},_checkedAllItems:false,_toggleCheckAllItems:function(a){var b,c,d;if(a){if(this._freeSpaceLimited){c=this._getFreeSpace()}if(this._selectedCountLimited){d=this._maxSelected-this.getSelectedCount()}}for(var e=0;e<this.itemList.getCount();e++){b=this._viewListData[e];if(!b.selectable||!!b.selected==a){continue}if(a){if(this._freeSpaceLimited&&b.size>c){continue}if(this._selectedCountLimited&&d===0){continue}d--}b.selected=a;this.itemList.setItemSelected(b.id,a);this._updateSelectedList(b);if(+b.size){c-=+b.size}}if(!this._hasFreeSelectedCount()){this.itemList.disableUnselected();this._renderCheckAllCheckbox();return}if(!this._freeSpaceLimited){this.itemList.enableUnselected()}this._updateViewListFreeSpace();this._renderCheckAllCheckbox()},_renderCheckAllCheckbox:function(){if(!this.itemCheckboxCheckAll){return}var a=this.itemCheckboxCheckAll.getData(),b=$.extend({},a);if(this.itemList.hasSelectedItem()){a.checkedMixed=!this.itemList.isAllItemsChecked();a.checked=true;a.disabled=false;if(a.checkedMixed){this._isCheckedAllByUser=false}}else{a.checked=false;a.checkedMixed=false;a.disabled=!this.itemList.hasSelectableItems()}if(!g.isEqual(a,b)){this.itemCheckboxCheckAll.render()}},_updateCheckAllStatus:function(){this._renderCheckAllCheckbox()},_resortItems:function(a,b){var c=this._activeFolder,d=this._getCurrentModel(),e;this._currentSortFiled=a;this._isSortReverse=!!b;if(this._secureDialogOpened){return}if(d.hasServerSort){if(this._currentSearchQuery){if(!d._localSearch&&this._searchFolder._hasPaginate){this._search(true);return}}else{this._activeFolder=null;this.setActiveFolder(c);return}}this._renderViewList()},_localSearch:function(){var a=[];if(this._previousSearchQuery!==""&&this._currentSearchQuery.indexOf(this._previousSearchQuery)!==-1){this._localSearchData(a,this._viewListData);if(a.length!==this._viewListData.length){this._renderViewList(a);this._renderCheckAllCheckbox()}}else{this._localSearchData(a);this._renderViewList(a);this._renderCheckAllCheckbox()}},_localSearchData:function(a,b){var c=this._getCurrentModel(),d;b=b||this._getCurrentData().items;if(!Array.isArray(b)){b=[b]}for(var e=b.length-1;e>=0;e--){if(a.indexOf(b[e])!==-1){continue}if(b[e].items&&b[e].items.length){this._localSearchData(a,b[e].items)}if(c.hideFolders&&b[e].type==="folder"){continue}for(var f=0;f<c.localSearchFields.length;f++){d=b[e][c.localSearchFields[f]];if(this._isLocalSearchItemCorrect(d,this._currentSearchQuery)){a.push(b[e]);break}}}},_isLocalSearchItemCorrect:function(a,b){if(!Array.isArray(a)){a=[a]}for(var c=0;c<a.length;c++){if(typeof a[c]!=="string"){continue}if(a[c].toLowerCase().replace(/ё/g,"е").indexOf(b)!==-1){return true}}return false},_currentSearchQuery:"",_search:function(a){var b=this._getCurrentModel(),c=this._currentSearchQuery,d=a?0:this._searchFolder.items.length,e;this._closeSecureDisalog();if(b.localSearch){this._localSearch();return}e=d&&this.itemList.isAllItemsChecked()&&this._isCheckedAllByUser;b.search(c,{offset:d,sortField:this._currentSortFiled,sortReverse:this._isSortReverse,id:this._activeFolder}).done(function(f){if(this._currentSearchQuery!==c){return}if(a){this._searchFolder.items=[]}this._checkDataDublicate(f.files,b);this._searchFolder.items=this._searchFolder.items.concat(f.files);if(d===0){this._renderViewList(f.files);this._renderCheckAllCheckbox()}else{var h;if(this._currentSortFiled&&b.enableClientSort){h=g.sortItems(f.files.slice(),this._currentSortFiled,this._isSortReverse);this.itemList.appendItems(h)}else{h=f.files;this.itemList.appendItems(f.files)}this._viewListData=this._viewListData.concat(h)}if(this._hasFreeSelectedCount()){this._updateViewListFreeSpace()}else{this.itemList.disableUnselected()}this._searchFolder._hasPaginate=f.files.length>b.loadLimit;this._renderViewListPagination(this._searchFolder);this._checkSelectedAfterScroll(e);if(d){try{this.emit("scroll",{count:this._viewListData.length,search:true})}catch(a){}}}.bind(this))},_checkSelectedAfterScroll:function(a){if(a){this._toggleCheckAllItems(true)}else{if(this._hasFreeSelectedCount()){this._updateViewListFreeSpace()}else{this.itemList.disableUnselected()}this._updateCheckAllStatus()}},_toggleSpinner:function(a){b.toggleMod(this.$(".b-explorer__loader"),"hidden",!a)},_paginateOnScroll:function(){if(this._currentSearchQuery){this._search();return}var b=this._getDataItemById(this._activeFolder),c=this.itemList.isAllItemsChecked()&&this._isCheckedAllByUser,d=this._getCurrentModel();this._lastLazyLoadRequest++;var e=this._lastLazyLoadRequest;this._fetchModelData({item:b,checkAll:c,model:d,currentRequestID:e,itemListCount:this.itemList.getCount()}).then(function(){if(a.default.has("paginate-filelist")){this.prevActiveFolder=this._activeFolder;this.ignoreRootRender=true;this.setActiveFolder("/");b=this._getDataItemById(this._activeFolder);c=this.itemList.isAllItemsChecked()&&this._isCheckedAllByUser;d=this._getCurrentModel();this._lastLazyLoadRequest++;e=this._lastLazyLoadRequest;this._fetchModelData({item:b,checkAll:c,model:d,currentRequestID:e,itemListCount:b.items.length})}}.bind(this))},_fetchModelData:function(a){var b=a.item,c=a.checkAll,d=a.model,e=a.currentRequestID,f=a.itemListCount;return this._getModelItem(b.id,f).done(function(a){if(e!=this._lastLazyLoadRequest||b.id!=this._activeFolder){return}if(this.prevActiveFolder){this.ignoreRootRender=false;this.setActiveFolder(this.prevActiveFolder);this.prevActiveFolder=null}var f,h;if(d.hideFolders){f=a.files}else{f=a.folders.concat(a.files)}this._setParent(f,b);h=f.length;this._checkDataDublicate(f,d);b.items=b.items.concat(f);this._checkPagination(d.id,b.id,h);if(a.folders.length&&!d.hideFolders){this._renderTree()}for(var i=f.length-1;i>=0;i--){this._checkDefaultSelected(f[i])}var j=f.slice();if(this._activeFolder==b.id){if(this._currentSortFiled&&d.enableClientSort){this.itemList.appendItems(g.sortItems(j,this._currentSortFiled,this._isSortReverse))}else{this.itemList.appendItems(j)}this._viewListData=this._viewListData.concat(j);this._renderViewListPagination(b)}this._checkSelectedAfterScroll(c);if(a.folders.length){this._renderTree();this._getCurrentNavigate().setActiveItem(b.id)}try{this.emit("scroll",{count:f.length,modelID:d.id})}catch(a){}}.bind(this))}})});define("ui-block/explorer/models/explorer-models-cloud",["exports","cloud/Entry","feast-mod/file-size"],function(exports,a,b){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var c=d(a);function d(a){return a&&a.__esModule?a:{default:a}}exports.default={id:"cloud",model:c.default,loadLimit:40,rootTitle:i18n("Облако"),enableSearch:false,hasServerSort:true,unlimitedSpace:true,modelConvertor:function a(c){var d={id:c.id};if(c.isFolder()){d.type="folder"}else if(c.attributes.kind==="image"){d.type="image"}else{d.type=c.getExtension()}d.text=c.attributes.name;if(c.attributes.kind==="image"){d.src=c.attributes.thumbnails["160x120"]}d.count=c.attributes.count;d.size=c.attributes.size;d.humanSize=(0,b.fileSize)(c.attributes.size);d.timestamp=c.attributes.mtime;return d},findIDParams:function a(b){return{folder:b}},addSortParams:function a(b,c,d){b.sort={};switch(c){case"timestamp":b.sort.type="mtime";break;case"text":b.sort.type="name";break;case"size":b.sort.type="size"}b.sort.order=d?"desc":"asc"}}});define("ui-block/explorer/adapters/utils",["exports","RPC","service/layer"],function(exports,a,b){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.cloudLoadErrorCallback=f;var c=e(a);var d=e(b);function e(a){return a&&a.__esModule?a:{default:a}}function f(a){if(a&&a.get&&a.get("status")==c.default.statuses.payment_required&&a.get("body.error")==="cloud_does_not_exists"){d.default.open("cloud-unavailable",{},{dimmer:true,compact:true,"close-on-dimmer":true,"close-on-esc":true,resolvable:true});return true}}});define("ui-block/explorer/adapters/explorer-from-cloud",["exports","ui-block/explorer/models/explorer-models-cloud","./utils"],function(exports,a,b){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var c=d(a);function d(a){return a&&a.__esModule?a:{default:a}}var e=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default={defaultData:{modelsList:["from-cloud"],title:i18n("Файлы из Облака"),searchTitle:i18n("Поиск в Облаке"),emptyFolderText:i18n("В папке нет файлов"),emptySearchText:i18n("Ничего не найдено"),defaultViewMode:"thumb",defaultSort:"text",viewMods:["thumb"],mods:["right-arrow"],sortItems:[{title:i18n("По имени"),field:"text"},{title:i18n("По дате"),field:"timestamp"},{title:i18n("По размеру"),field:"size"}]},modelData:e({},c.default,{id:"from-cloud",modelConvertor:function a(b){var d=c.default.modelConvertor(b);d.selectable=d.type!=="folder";d.disabled=false;d.alwaysDisabled=false;return d}}),loadErrorCallback:b.cloudLoadErrorCallback}});define("ui-block/explorer/models/MailContact",["exports","@mail/features","mail/Contact","RPC","service/addressbook/addressbook","service/auth"],function(exports,a,b,c,d,e){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var f=k(a);var g=k(b);var h=k(c);var i=k(d);var j=k(e);function k(a){return a&&a.__esModule?a:{default:a}}var l=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};var m=null;var n=null;var o=[];function p(a){return l({},a,{type:"folder"})}var q=i18n("- группа без названия -");var r=[p({text:i18n("Избранное"),id:"/favorites"})];var s=p({text:i18n("Мой Мир"),id:"/social/my_world"});var t=p({text:i18n("Мои контакты"),id:"/my"});var u=p({text:i18n("Контакты {domain}",{"unsafe-domain":j.default.user.get("domain")}),id:"/common"});var v=void 0;function w(a){if(!v.some(function(b){return b.id===a.id})){v.push(a)}}function x(a){var b=[];var c={};m.forEach(function(a){if(a.get("common_id")){c[a.get("common_id")]=true}});var d=m.slice(0);if(n){Object.keys(n).forEach(function(a){if(!c[a]){d.push(n[a])}})}switch(a){case"/":b=b.concat(v,o,d);break;case"/all":b=b.concat(d);break;case"/favorites":b=d.filter(function(a){return a.get("flags.star")});break;case"/my":b=d.filter(function(a){var b=a.get("flags")||{};var c=false;if(b.hasOwnProperty("non_manual")){c=!b.non_manual}else{c=!b.auto&&!b.import&&!b.corp}return c});break;case"/common":b=d.filter(function(a){return a.get("flags")&&a.get("flags.corp")||a.get("common_id")});break;case"/social/my_world":b=d.filter(function(a){if(a.get("social")){return false}return a.get("social").some(function(a){return a.type==="my"})});break;default:for(var e=o.length-1;e>=0;e--){if(a==o[e].id){for(var f=d.length-1;f>=0;f--){if(o[e].contacts.includes(d[f].id)){b.push(d[f])}}break}}}return b}function y(){for(var a=m.length-1;a>=0;a--){if(!m[a].social){continue}for(var b=m[a].social.length-1;b>=0;b--){if(m[a].social[b].type==="my"){w(s);return}}}}function z(){for(var a=m.length-1;a>=0;a--){if(!m[a].flags||!m[a].flags.auto&&!m[a].flags.non_manual&&!m[a].flags.import){w(t);return}}}exports.default={find:function a(b){return new Promise(function(a,c){var d=2;if(b.id==="/"){m=null;o=[];v=r.slice()}if(f.default.get("load-common-contacts")){w(u)}if(m){a(x(b.id));return}function e(){d--;if(d!==0){return}a(x(b.id))}var j={api:1,ajax_call:1};if(b.name_needle){j.name_needle=b.name_needle}h.default.call("ab").then(function(a){var b=a.body;m=b.contacts.map(function(a){return new g.default(a)}).filter(function(a){return a.get("emails.length")});o=b.labels.map(function(a){var b=a.name||"";if(b.trim()===""){b=q}return p({text:b,id:a.id,contacts:a.contacts})}).sort(function(a,b){return a.text.localeCompare(b.text)});z();y();e()}).catch(c);if(n){e();return}i.default.getCommonAddressBook(function(a){if(!a){e();return}n={};a.body.forEach(function(a){if(!a.flags){a.flags={}}if(!a.flags.corp){a.flags.corp=true}a.flags.non_manual=true;n[a.id]=new g.default(a)});e()},0,["id","emails","avatars","flags","name","display_name","labels"])})}}});define("ui-block/explorer/models/explorer-models-contacts",["exports","ui-block/explorer/models/MailContact"],function(exports,a){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var b=c(a);function c(a){return a&&a.__esModule?a:{default:a}}exports.default={model:b.default,rootTitle:i18n("Все контакты"),rootID:"/",defaultID:"/all",enableSearch:true,localSearch:true,localSearchFields:["text","value"],hideFolders:true,enableClientSort:true,loadLimit:null,_CONTACT_NONAME:i18n("- контакт без названия -"),findIDParams:function a(b){return{id:b}},searchQueryParams:function a(b){return{name_needle:b}}}});define("ui-block/explorer/adapters/explorer-from-contacts",["exports","ui-block/explorer/models/explorer-models-contacts"],function(exports,a){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var b=c(a);function c(a){return a&&a.__esModule?a:{default:a}}var d=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default={defaultData:{modelsList:["from-contacts"],title:i18n("Контакты"),searchTitle:i18n("Поиск по контактам"),emptyFolderText:i18n("В папке нет контактов"),emptySearchText:i18n("Ничего не найдено"),defaultSort:["selected","_nameForSort"],viewMods:["contactlabel"],mods:["main"]},modelData:d({},b.default,{id:"from-contacts",modelConvertor:function a(b){var c={id:b.id};if(b.type==="folder"){Object.assign(c,b);switch(c.id){case"/favorites":c.icon="b-icon_actions_rating";break;case"/my":c.icon="b-icon_navigation_user";break;case"/common":c.icon="b-icon_categories_club";break;case"/social/my_world":c.icon="b-icon_social_moimir";break;default:c.icon="b-icon_navigation_users"}return c}c.selectable=true;c.text=b.get("display_name")||b.get("nick")||"";if(c.text.trim()===""&&b.get("name")){c.text=(b.get("name.last")||"")+(b.get("name.last")&&b.get("name.first")?" ":"")+(b.get("name.first")||"")}if(c.text.trim()===""){c.text=this._CONTACT_NONAME;c._nameForSort="я"}else{c._nameForSort=c.text}var d=this.defaultSelected[this.id];for(var e=d.length-1;e>=0;e--){if(b.get("emails")[0]===d[e].email){if(d[e]._checked){break}c.selected=true;if(c.text===d[e].name){d[e].items.forEach(function(a){a.selected=false});d[e].items=[c];d[e]._checked=true}else{d[e].items.push(c)}d[e].id=c.id;break}}c.src=window.devicePixelRatio>1?b.get("avatars")["90x90"]:b.get("avatars")["32x32"];c.value=b.get("emails")[0];return c}})}});define("ui-block/explorer/models/legacy/mailAttachmentsUtils",["exports","feast-mod/file-size","helpers/decode-uri-component","helpers/object-to-query","RPC"],function(exports,a,b,c,d){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.createFileDescription=r;var e=h(b);var f=h(c);var g=h(d);function h(a){return a&&a.__esModule?a:{default:a}}var i=g.default.setup().email;var j=new Map([["psd"],["tga"],["ai"],["tif"],["tiff"],["eps"],["doc"],["docx"],["ppt"],["pptx"],["pdf"],["xls"],["xlsx"],["csv"]]);var k=new Map([["png"],["jpe"],["jpg"],["jpeg"],["gif"],["bmp"],["heic"]]);function l(a,b,c,d){var e="";var g={id:b.PartID,"x-email":i,bs:b.BodyStart,bl:b.OriginalBodyLen,ct:b.ContentType,cn:b.ContentName,cte:b.ContentEncoding};if(c){Object.assign(g,{notype:1})}if(d){Object.assign(g,{frame:1})}if(b.isTNEF&&!b.IsRtf){e="/cgi-bin/get_tnef_part?"+(0,f.default)(Object.assign(g,{tnef_id:b.tnef_id,mode:"tnef_attach"}),true)}else{var h="/cgi-bin/getattach?";if(!d){h=location.protocol+"//"+a.MainMailHost+h}e=h+(0,f.default)(Object.assign(g,{file:b.name,mode:"attachment",channel:b.Channel,"x-email":i}),true)}return e}function m(a){return a.ext==="psd"||a.ext==="tga"||a.ext==="ai"||a.ext==="tif"||a.ext==="tiff"||a.ext==="eps"}function n(a){var b="other";var c=a.ext;if(a.IsImage||a.AddPhoto||c==="png"||c==="gif"||c==="jpeg"||c==="jpg"||c==="bmp"||c==="tiff"){b="image"}else if(c==="doc"||c==="docx"||c==="wpd"||c==="wps"||c==="rtf"){b="doc"}else if(c==="xls"||c==="xlsx"||c==="xlsb"||c==="xlsm"){b="excel"}else if(c==="ppt"||c==="pptx"||c==="pps"||c==="ppsx"){b="pp"}else if(c==="pdf"){b="pdf"}else if(c==="zip"||c==="rar"||c==="7z"||a.ContentType==="application/zip"&&a.ext!=="docx"&&a.ext!=="xlsx"&&a.ext!=="pptx"||a.ContentType==="application/x-rar-compressed"){b="archive"}else if((a.ContentText||a.entry)&&c==="txt"){b="text"}return b}function o(a){var b=a.ext;if(a.IsMp3){b="mp3"}else if(a.ContentType==="application/zip"&&a.ext!=="docx"&&a.ext!=="xlsx"&&a.ext!=="pptx"){b="zip"}else if(a.ContentType==="application/x-rar-compressed"){b="rar"}return b}function p(a,b){var c="";var d={id:b.PartID,"x-email":i};if(b.isTNEF&&!b.IsRtf){c="/cgi-bin/get_tnef_part?"+(0,f.default)(Object.assign({},d,{tnef_id:b.tnef_id,mode:"tnef_attach"}),true)}else if(m(b)){c="//docs."+a.SingleDomainName+"/preview/?"+(0,f.default)({src:b.downloadUrl},true)}else if(b.ShowThumbnail&&(b.IsImage||b.AddPhoto)){Object.assign(d,{exif:1});c="//"+a.MailAttachPreviewHost+"/cgi-bin/readmsg/"+encodeURIComponent(b.name)+"?"+(0,f.default)(d,true)}return c}function q(a,b,c,d,e){var g="";var h={"x-email":i};if(j.has(b.ext)&&!b.entry){Object.assign(h,{src:b.downloadUrl});if(d===305&&e===230){g="//docs."+a.SingleDomainName+"/preview/305x230/?"+(0,f.default)(h,true)}else if(d===160&&e===120){g="//docs."+a.SingleDomainName+"/preview/160x120/?"+(0,f.default)(h,true)}else if(arguments.length===3&&c===90){g="//docs."+a.SingleDomainName+"/preview/90x90/?"+(0,f.default)(h,true)}else if(arguments.length===2){g="//docs."+a.SingleDomainName+"/preview/206x206/?"+(0,f.default)(h,true)}}else if(k.has(b.ext)&&(b.AddPhoto||b.IsImage&&!b.isTNEF)){var l=d&&e?d+"x"+e:"default";if(b.thumbnails&&b.thumbnails.image&&b.thumbnails.image[l]){g=b.thumbnails.image[l]}else{Object.assign(h,{id:b.PartID,mode:"attachment"});if(b.ShowThumbnail){h.preview=1;h.exif=1}if(c){h.ps=c}if(d){h.fx=d}if(e){h.fy=e}}g="//"+a.MailAttachPreviewHost;g+="/cgi-bin/readmsg/"+encodeURIComponent(b.name)+"?"+(0,f.default)(h,true)}return g}function r(b,c,d){if(c.ContentName){try{c.ContentName=(0,e.default)(c.ContentName);c.ContentEncoding=(0,e.default)(c.ContentEncoding)}catch(a){}}var f=Object.assign({Subject:"",name:"",size:0,PartID:"",Channel:"",tnef_id:"",ContentText:"",ContentType:"",isRFC822:0,DontShow:0,ForceAddNotype:0,ShowThumbnail:0,AddPhoto:0,IsImage:0,isTNEF:0,IsRtf:0,IsMp3:0,ext:"",BodyStart:"",OriginalBodyLen:"",ContentName:"",ContentEncoding:"",encrypted:0,isFolder:0},c);if(f.isRFC822){if(f.Subject){f.name=f.Subject}else{f.name=i18n("<Без темы>")}f.ext="eml"}else{if(f.FileName){f.name=f.FileName}f.name=""+f.name;f.ext=f.name.replace(/^.*?(?:\.([^.]+))?$/,"$1").toLowerCase()}f.iconType=o(f);f.availableEditing=false;f.attachPreviewUrl="";f.downloadUrl=f.downloadUrl||l(b,f,true);f.downloadFromZipUrl=f.downloadFromZipUrl||"";f.previewWithCropUrl=f.previewWithCropUrl||q(b,f,0,305,230);f.previewUrl=f.previewUrl||q(b,f,90);f.previewMSVUrl=f.previewMSVUrl||"";f.defaultPreviewUrl=f.defaultPreviewUrl||"";f.messageReadUrl=f.messageReadUrl||"";f.imageUrl=f.imageUrl||p(b,f);f.addPhotoUrl=f.addPhotoUrl||"";f.notypeInFrameUrl=f.notypeInFrameUrl||l(b,f,false,true);f.mp3Url=f.mp3Url||"";f.type=n(f);f.humanSize=(0,a.fileSize)(f.size);f.index=d;f.ShowThumbnail=0;if(m(f)){f.ShowThumbnail=1}return f}});define("ui-block/explorer/models/MailAttachment",["exports","cfg","data-source/index","mail/AttachSearch","ui-block/explorer/models/legacy/mailAttachmentsUtils"],function(exports,a,b,c,d){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var e=h(a);var f=h(b);var g=h(c);function h(a){return a&&a.__esModule?a:{default:a}}var i=e.default.get("urls.mailAttachPreviewHost")||"apf.mail.ru";var j=e.default.get("urls.singleDomainName")||"mail.ru";var k=void 0;function l(a,b,c){var e={};var f=void 0;var g=0;for(var h=0;h<a.length;h++){if(a[h].attributes.parent!=c){continue}f=Object.assign(Object.create(Object.getPrototypeOf(a[h])),a[h]);f.attributes=Object.assign(Object.create(Object.getPrototypeOf(f.attributes)),f.attributes);if(f.attributes.children){f.attributes.count={folders:1}}e[g]=f;g++}var k={MainMailHost:location.host,MailAttachPreviewHost:i,SingleDomainName:j};for(var l=0;l<b.length;l++){var m=Object.assign(Object.create(Object.getPrototypeOf(b[l].attributes)),b[l].attributes);m.PartID=m.id;m.id=m.id.replace(/;\d+;\d+$/,"");k.id=m.id;if(m.content_type_id==1){m.ShowThumbnail=1;m.IsImage=1}m=(0,d.createFileDescription)(k,m,l);b[l].attributes=m;e[g]=b[l];g++}e.length=g;return e}exports.default={find:function a(b){return new Promise(function(a){var c=2,d=void 0;function e(){c--;if(c!==0){return}if(b.offset||b.name_needle){a(l([],d,b.id))}else{a(l(k,d,b.id))}}var h={folder_id:b.id,limit:b.limit,offset:b.offset,func_name:"ajax_search",ajax_call:1};if(b.name_needle){h.name_needle=b.name_needle}g.default.find(h).then(function(a){d=a;e()});k=f.default.getData().folders;e()})},secureOpen:function a(b,c){var d=void 0;for(var e=k.length-1;e>=0;e--){if(k[e].id==b){d=k[e];break}}return new Promise(function(a,b){var e=d.secureOpen(c);e.then(function(){a("ico_folder_secret_open")});e["catch"](function(a){try{if(a.status===429){b(i18n("Неверный пароль, попробуйте позднее"));return}if(a.body["folders[0].secret.folder_password"].error==="invalid"){b(i18n("Неверный пароль, попробуйте еще раз"));return}}catch(a){}b(i18n("Ошибка, попробуйте еще раз"))})})}}});define("ui-block/explorer/models/explorer-models-mail",["exports","feast-mod/file-size","mail/Folder","ui-block/explorer/models/MailAttachment"],function(exports,a,b,c){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var d=f(b);var e=f(c);function f(a){return a&&a.__esModule?a:{default:a}}exports.default={id:"mail",model:e.default,loadLimit:40,rootTitle:i18n("Почта"),rootID:"-1",hideFolders:true,enableSearch:true,hasServerSort:false,unlimitedSpace:false,defaultID:null,modelConvertor:function b(c){var e={id:c.id};if(!c.isFileSearch){e.type="folder";switch(true){case c.isSecure():e.secure=true;if(c.isSecureOpen()){e.icon="ico_folder_secret_open";e.open=true}else{e.icon="ico_folder_secret";e.open=false}break;case c.id==d.default.INBOX:e.icon="ico_folder_inbox";break;case c.id==d.default.ARCHIVE:e.icon="ico_folder_archive";break;case c.id==d.default.SPAM:e.icon="ico_folder_spam";break;case c.id==d.default.TRASH:e.icon="ico_folder_trash";break;case c.id==d.default.TEMPLATES:e.icon="ico_folder_templates";break;case c.id==d.default.DRAFTS:e.icon="ico_folder_drafts";break;case c.id==d.default.SENT:e.icon="ico_folder_send";break;case c.id==d.default.SOCIAL:e.icon="ico_folder_social";break;case c.id==d.default.PROMOTIONS:e.icon="ico_folder_promotions";break;case c.id==d.default.NEWSLETTERS:e.icon="ico_folder_newsletters";break}}else if(c.attributes.type==="image"){e.type="image"}else{e.type=c.getExtension()}e.text=c.attributes.name;e.src=c.attributes.previewWithCropUrl;e.count=c.attributes.count;e.humanSize=(0,a.fileSize)(c.attributes.size);e.size=c.attributes.size;e.timestamp=c.attributes.time;return e},findIDParams:function a(b){return{id:b}},searchQueryParams:function a(b){return{name_needle:b}},openSecureFolder:function a(b,c){return e.default.secureOpen(b,c)}}});define("ui-block/explorer/adapters/explorer-from-filesearch",["exports","ui-block/explorer/models/explorer-models-mail"],function(exports,a){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var b=c(a);function c(a){return a&&a.__esModule?a:{default:a}}var d=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default={defaultData:{modelsList:["mail"],title:i18n("Файлы из Почты"),searchTitle:i18n("Поиск в Почте"),emptyFolderText:i18n("В папке нет файлов"),emptySearchText:i18n("Ничего не найдено"),defaultViewMode:"thumb",defaultSort:"text",password:{title:i18n("Пароль для доступа к папке"),btnEnter:i18n("Войти"),forgotPassword:i18n("Забыли пароль?"),emptyPassword:i18n("Обязательное поле"),restoreURL:"",folderRecovery:false},viewMods:["thumb"],mods:["right-arrow"]},modelData:d({},b.default,{id:"mail",modelConvertor:function a(c){var d=b.default.modelConvertor(c);d.selectable=d.type!=="folder";d.disabled=false;d.alwaysDisabled=false;return d}})}});define("ui-block/explorer/adapters/explorer-to-cloud",["exports","ui-block/explorer/models/explorer-models-cloud","./utils"],function(exports,a,b){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var c=d(a);function d(a){return a&&a.__esModule?a:{default:a}}var e=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default={defaultData:{type:"saveas",modelsList:["to-cloud"],title:i18n("Сохранить в Облако"),emptyFolderText:i18n("В папке нет файлов"),emptySearchText:i18n("Ничего не найдено"),defaultViewMode:"thumb",defaultSort:"text",viewMods:["thumb"],mods:["right-arrow"],saveasValue:"",saveasPlaceholder:i18n("Введите название файла"),saveasMods:["disabled"]},modelData:e({},c.default,{id:"to-cloud",enableSearch:false,modelConvertor:function a(b){var d=c.default.modelConvertor(b);var e=d.type==="folder";d.selectable=false;d.disabled=!e;d.alwaysDisabled=!e;return d}}),loadErrorCallback:b.cloudLoadErrorCallback}});define("ui-block/explorer/explorer-types",["require","exports"],function(require,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default={TO_CLOUD:"to-cloud",FROM_CLOUD:"from-cloud",FROM_FILESEARCH:"from-filesearch",FROM_CONTACTS:"from-contacts"}});define("ui-block/explorer/explorer",["exports","feast","feast-tpl!./explorer.html","mrg-explorer/b-explorer/b-explorer","service/layer","service/radars/index","service/storage","./adapters/explorer-from-cloud","./adapters/explorer-from-contacts","./adapters/explorer-from-filesearch","./adapters/explorer-to-cloud","./explorer-types"],function(exports,a,b,c,d,e,f,g,h,i,j,k){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var l=v(a);var m=v(b);var n=v(c);var o=v(d);var p=v(e);var q=v(g);var r=v(h);var s=v(i);var t=v(j);var u=v(k);function v(a){return a&&a.__esModule?a:{default:a}}var w=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};function x(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++){c[b]=a[b]}return c}else{return Array.from(a)}}var y;function z(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:true,configurable:true,writable:true})}else{a[b]=c}return a}var A=(y={default:t.default},z(y,u.default.TO_CLOUD,t.default),z(y,u.default.FROM_CLOUD,q.default),z(y,u.default.FROM_FILESEARCH,s.default),z(y,u.default.FROM_CONTACTS,r.default),y);var B=(0,f.createScopeStorage)();var C=l.default.Block.extend({name:"explorer",template:m.default,performanceTrace:true,blocks:{},defaults:{loading:true},events:{},didMount:function a(){var b=this;this.explorerFactory(this.refs.explorer);this.explorerBlock.on("sort",function(a,c){return b.broadcastEvent("sort:click",c)});this.explorerBlock.on("search",function(a,c){return b.broadcastEvent("search:click",c)});this.explorerBlock.on("folderclick",function(a,c){return b.broadcastEvent("folder:click",c)});this.explorerBlock.on("selectclick",function(a,c){return b.broadcastEvent("item:select",c)});this.explorerBlock.on("checkall",function(a,c){return b.broadcastEvent("item:select:all",c)});this.explorerBlock.on("scroll",function(a,c){return b.broadcastEvent("scroll",c)});this.explorerBlock.on("cachescroll",function(a,c){return b.broadcastEvent("cache:scroll",c)});this.explorerBlock.on("licenseopen",this.openLicenseDialog.bind(this))},broadcastEvent:function a(b,c){switch(b){case"sort:click":case"folder:click":case"search:click":(0,p.default)(["explorer",this.get("type")].concat(x(b.split(":"))))}this.broadcast(b.split(":").join("-"),c)},didUnmount:function a(){this.explorerBlock=null},getAdapter:function a(b){var c=A[b];if(!c){c=A.default}return c},getData:function a(b){var c=this.getAdapter(b),d=c.defaultData,e=c.modelData,f=c.loadErrorCallback;var g=w({},d,{loadErrorCallback:f});var h=void 0;var i=void 0;if(b===u.default.FROM_CONTACTS){h=this.get("contacts")}else{i=this.get("attachments")}switch(b){case u.default.FROM_CONTACTS:g.defaultSelected=z({},e.id,h.map(function(a){var b=a.name,c=a.email;g.selectLimit+=1;return{email:c,name:b,items:[]}}));e.defaultSelected=g.defaultSelected;break;case u.default.TO_CLOUD:if(i.length===1){g.saveasValue=i[0].get("name")}break;case u.default.FROM_CLOUD:case u.default.FROM_FILESEARCH:g.freeSpace=this.get("free-space");g.selectLimit=this.get("select-limit");g.defaultSelected=z({},e.id,i.map(function(a){g.selectLimit+=1;if(a.isFromAttachSearch()||a.isFromCloud()){g.freeSpace+=a.get("size")}return{id:a.isFromAttachSearch()?a.getFileSearchAttachId():a.get("cloud_id"),size:a.get("size")}}));break}return g},getModel:function a(b){return this.getAdapter(b).modelData},explorerFactory:function a(b){var c=this;var d=this.get("type");var e=this.getData(d);var f=this.getModel(d);this.explorerBlock=new n.default({data:e,template:"mailru-toolkit.lego",templateBlock:"b-explorer",dirtyCheck:true,renderMode:"replace"});this.explorerBlock.setElement(b);this.explorerBlock.render(e);this.explorerBlock.initInner(this.explorerBlock.$el);this.explorerBlock.setFreeSpace(e.freeSpace);this.explorerBlock.initModel(f,false).then(function(){if(!c.isMounted()){return}var a=c.getStorageFolder();return a&&c.setInnerFolder(a)},function(a){if(e.loadErrorCallback){var b=e.loadErrorCallback(a);if(b){c.broadcast("cancel")}}(0,p.default)(["explorer",c.get("type"),"load-error"])}).always(function(){c.set("loading",false);c.broadcast("loaded");(0,p.default)(["explorer",c.get("type"),"loaded"])})},openLicenseDialog:function a(){var b=this;o.default.open("cloud-license",{},{dimmer:true,resolvable:true,"reject-on-close":true}).then(function(){b.explorerBlock.onLicenseAccept()}).catch(function(){b.broadcastEvent("cancel")})},updateActiveTree:function a(){return this.explorerBlock.updateActiveTree()},setInnerFolder:function a(b){var c=this;var d=this.getAdapter(this.get("type")),e=d.modelData;return e.model.find({folder:b,limit:10,offset:0}).then(function(){var a=c.getFolderParents(b);return a.reduce(function(a,b){return a.then(function(){return c.explorerBlock.setActiveFolder(b)})},Promise.resolve())}).catch(function(){})},getActiveFolderId:function a(){return this.explorerBlock.getActiveFolderId()},getFreeSpace:function a(){return this.explorerBlock._getFreeSpace()},getSelectedContacts:function a(){var b=this.get("type");var c=this.getAdapter(b),d=c.modelData;return this.explorerBlock.getSelected()[d.id]||[]},getSelectedFiles:function a(){var b=this.get("type");var c=this.getAdapter(b),d=c.modelData;return{loaded:this.explorerBlock.getSelected()[d.id]||[],preset:this.explorerBlock.getUloadedDefaultSelected()[d.id]||[]}},getSelectedSize:function a(){return this.explorerBlock._getSelectedSize()},getSelectedCount:function a(){return this.explorerBlock.getSelectedCount()},hasFreeSelectedCount:function a(){return this.explorerBlock._hasFreeSelectedCount()},getStorageFolder:function a(){return B.get("explorer:"+this.get("type"))},setStorageFolder:function a(){var b=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"/";B.set("explorer:"+this.get("type"),b)},getFolderParents:function a(b){var c=[];b.split("/").slice(1).reduce(function(a,b){a&&c.push(a);return a+"/"+b},"");c.push(b);return c}});exports.default=C});define("ui-block/layer-explorer-to-cloud/layer-explorer-to-cloud",["exports","cfg","feast","feast-mod/file-count","feast-tpl!./layer-explorer-to-cloud.html","mail/actions/AddToCloud","service/layer","service/notify","ui-block/explorer/explorer","ui-block/explorer/explorer-types","ui-block/layer/layer","../../default-values"],function(exports,a,b,c,d,e,f,g,h,i,j,k){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var l=u(a);var m=u(b);var n=u(d);var o=u(e);var p=u(f);var q=u(g);var r=u(h);var s=u(i);var t=u(j);function u(a){return a&&a.__esModule?a:{default:a}}exports.default=m.default.Block.extend({name:"layer-explorer-to-cloud",template:n.default,needToolkit:true,blocks:{layer:t.default,explorer:r.default},events:{cancel:"onCancel","create-folder":"onCreateFolder","explorer:loaded":"onLoad",save:"onSave"},defaults:{attachments:null,loading:true,type:s.default.TO_CLOUD},getExplorer:function a(){return this.ids["b-explorer"]},getActiveFolder:function a(){return this.getExplorer().getActiveFolderId()},onCreateFolder:function a(){var b=this.getExplorer();var c=this.getActiveFolder();p.default.open("cloud-create-folder",{parent:c},{dimmer:true,resolvable:true}).then(function(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},c=a.type,d=a.name;if(c==="ok"){b.updateActiveTree().then(function(){b.setInnerFolder(d)})}})},onLoad:function a(){this.set("loading",false)},onSave:function a(){var b=this;var d=this.getExplorer();var e=d.getActiveFolderId();var f=this.get("attachments");if(!e){console.warn("no active folder");return}this.set("loading",true);o.default.execute({folder:e,message:this.get("message"),attachments:f}).then(function(a){b.broadcast("layer:hide");var d=a.result;var e=d[0];var g={text:i18n("Файл сохранён"),qa:"cloud-file-saved",actions:[{text:i18n("Открыть"),link:k.CLOUD_HOME_URL+encodeURIComponent(e)}]};if(f.length>1){g={text:(0,c.fileCountSaved)(f.length)+i18n(" в Облако")}}q.default.add(g)}).catch(function(a){var c=a.error.body;var d={type:q.default.types.error};b.set("loading",false);if(c==="quota_exceeded"){d.text=i18n("Не хватает места для сохранения файла.");d.actions=[{text:i18n("Подробнее"),link:l.default.get("urls.helpUrl")+"/cloud_web/size/increase"}]}else{d.text=i18n("Что-то пошло не так!");console.error(a)}q.default.add(d,"layer-window")})},onCancel:function a(){this.broadcast("layer:hide")},onBeforeHide:function a(){var b=this.getExplorer();var c=this.getActiveFolder();b.setStorageFolder(c)}})});define("feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-cloud/layer-explorer-from-cloud.html",["feast"],function(a){return a.smartParse('<div>\n\t<b:layer name="explorer"\n\t\t\t remit:close="close"\n\t\t\t close\n\t\t\t standard\n\t\t\t qa:id="layer-attachment-from-cloud"\n\t>\n\n\t\t<fn:match name="content">\n\t\t\t<b:explorer id="b-explorer"\n\t\t\t\t\t\ttype="{attrs.type}"\n\t\t\t\t\t\tslim="{attrs.slim}"\n\t\t\t\t\t\tfree-space="{attrs[\'free-space\']}"\n\t\t\t\t\t\tselect-limit="{attrs[\'select-limit\']}"\n\t\t\t\t\t\tattachments="{attrs.attachments}"\n\t\t\t\t\t\tuse:mediator="layout-manager"\n\t\t\t\t\t\tremit:cancel="cancel"\n\t\t\t\t\t\tremit:loaded="explorer:loaded"\n\t\t\t\t\t\tremit:scroll="explorer:scroll"\n\t\t\t\t\t\tremit:item-select="explorer:item:select"\n\t\t\t\t\t\tremit:item-select-all="explorer:item:select:all"\n\t\t\t/>\n\t\t</fn:match>\n\n\t\t<fn:match name="footer">\n\t\t\t<b:button2 remit:click="attach"\n\t\t\t\t\t  qa:id="attach"\n\t\t\t\t\t  text="{i18n(\'Прикрепить\')}"\n\t\t\t\t\t  primary\n\t\t\t\t\t  disabled="{attrs.loading}"\n\t\t\t\t\t  size="m"/>\n\t\t\t<b:button2 remit:click="cancel"\n\t\t\t\t\t  qa:id="cancel"\n\t\t\t\t\t  text="{i18n(\'Отменить\')}"\n\t\t\t\t\t  disabled="{attrs.loading}"\n\t\t\t\t\t  size="m"/>\n\n\t\t\t<span class="layer-explorer__selected-files">\n\t\t\t\t{_this._getSelectedText(attrs.selected)}\n\t\t\t</span>\n\t\t</fn:match>\n\t</b:layer>\n</div>\n',"app/feast-tpl!ui-block/layer-explorer-from-cloud/layer-explorer-from-cloud.html")});define("feast-tpl!ui-block/layer-explorer-from-cloud/layer-explorer-from-cloud.html",["feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-cloud/layer-explorer-from-cloud.html"],function(a){return a});define("ui-block/layer-explorer-from-cloud/layer-explorer-from-cloud",["exports","feast","feast-mod/file-size","feast-tpl!./layer-explorer-from-cloud.html","ui-block/button2/button2","ui-block/explorer/explorer","ui-block/explorer/explorer-types","ui-block/layer/layer"],function(exports,a,b,c,d,e,f,g){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var h=o(a);var i=o(b);var j=o(c);var k=o(d);var l=o(e);var m=o(f);var n=o(g);function o(a){return a&&a.__esModule?a:{default:a}}var p=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default=h.default.Block.extend({name:"layer-explorer-from-cloud",template:j.default,needToolkit:true,blocks:{button2:k.default,layer:n.default,explorer:l.default},events:{close:"onClose",cancel:"onCancel",attach:"onAttach","explorer:loaded":"onLoad","explorer:scroll":"onItemSelect","explorer:item:select":"onItemSelect","explorer:item:select:all":"onItemSelect"},defaults:{loading:true,type:m.default.FROM_CLOUD,selected:0},getExplorer:function a(){return this.ids["b-explorer"]},onLoad:function a(){this.set({loading:false,selected:this.getExplorer().getSelectedCount()})},onItemSelect:function a(){this.set("selected",this.getExplorer().getSelectedCount())},onAttach:function a(){var b=this.getExplorer();var c=b.getSelectedFiles(),d=c.loaded,e=c.preset;var f=[];var g=[];var h=this.get("attachments");this.set("loading",true);h.forEach(function(a){if(e.find(function(b){return b===a.get("cloud_id")})){return}if(!d.find(function(b){return b.id===a.get("cloud_id")})){g.push(a)}});d.forEach(function(a){var b=h.find(function(b){return b.get("cloud_id")===a.id});if(!b){f.push(a)}});this.resolveLayer("attach",{add:f,remove:g});this.broadcast("layer:hide")},onClose:function a(){this.resolveLayer("close");this.broadcast("layer:close")},onCancel:function a(){this.resolveLayer("cancel");this.broadcast("layer:hide")},resolveLayer:function a(b){var c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.broadcast("layer:resolve",{resolveData:p({type:b},c)})},_getSelectedText:function a(b){if(this.is("loading")){return""}var c=this.getExplorer();var d=!c.hasFreeSelectedCount();var e=c.getSelectedSize();var f=i18n.plural(b,[i18n("Выбрано {count} файлов",{count:b}),i18n("Выбран {count} файл",{count:b}),i18n("Выбрано {count} файла",{count:b})]);var g=i18n.plural(b,[i18n("Выбрано максимальное количество в {count} файлов",{count:b}),i18n("Выбрано максимальное количество в {count} файл",{count:b}),i18n("Выбрано максимальное количество в {count} файла",{count:b})]);return(d?g:f)+(" ("+(0,i.default)(e)+")")}})});define("feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-filesearch/layer-explorer-from-filesearch.html",["feast"],function(a){return a.smartParse('<div>\n\t<b:layer\n\t\tname="explorer"\n\t\tremit:close="close"\n\t\tclose\n\t\tstandard\n\t\tqa:id="layer-attachment-from-filesearch"\n\t>\n\n\t\t<fn:match name="content">\n\t\t\t<b:explorer\n\t\t\t\tid="b-explorer"\n\t\t\t\ttype="{attrs.type}"\n\t\t\t\tslim="{attrs.slim}"\n\t\t\t\tfree-space="{attrs[\'free-space\']}"\n\t\t\t\tselect-limit="{attrs[\'select-limit\']}"\n\t\t\t\tattachments="{attrs.attachments}"\n\t\t\t\tuse:mediator="layout-manager"\n\t\t\t\tremit:loaded="explorer:loaded"\n\t\t\t\tremit:scroll="explorer:scroll"\n\t\t\t\tremit:item-select="explorer:item:select"\n\t\t\t\tremit:item-select-all="explorer:item:select:all"\n\t\t\t/>\n\t\t</fn:match>\n\n\t\t<fn:match name="footer">\n\t\t\t<b:button2\n\t\t\t\tremit:click="attach"\n\t\t\t\tqa:id="attach"\n\t\t\t\ttext="{i18n(\'Прикрепить\')}"\n\t\t\t\tprimary\n\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\tsize="m"\n\t\t\t/>\n\t\t\t<b:button2\n\t\t\t\tremit:click="cancel"\n\t\t\t\tqa:id="cancel"\n\t\t\t\ttext="{i18n(\'Отменить\')}"\n\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\tsize="m"\n\t\t\t/>\n\n\t\t\t<span class="layer-explorer__selected-files">\n\t\t\t\t{_this._getSelectedText(attrs.selected)}\n\t\t\t</span>\n\t\t</fn:match>\n\t</b:layer>\n</div>\n',"app/feast-tpl!ui-block/layer-explorer-from-filesearch/layer-explorer-from-filesearch.html")});define("feast-tpl!ui-block/layer-explorer-from-filesearch/layer-explorer-from-filesearch.html",["feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-filesearch/layer-explorer-from-filesearch.html"],function(a){return a});define("ui-block/layer-explorer-from-filesearch/layer-explorer-from-filesearch",["exports","feast","feast-mod/file-size","feast-tpl!./layer-explorer-from-filesearch.html","ui-block/button2/button2","ui-block/explorer/explorer","ui-block/explorer/explorer-types","ui-block/layer/layer"],function(exports,a,b,c,d,e,f,g){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var h=o(a);var i=o(b);var j=o(c);var k=o(d);var l=o(e);var m=o(f);var n=o(g);function o(a){return a&&a.__esModule?a:{default:a}}var p=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default=h.default.Block.extend({name:"layer-explorer-from-filesearch",template:j.default,needToolkit:true,blocks:{button2:k.default,layer:n.default,explorer:l.default},events:{close:"onClose",cancel:"onCancel",attach:"onAttach","explorer:loaded":"onLoad","explorer:scroll":"onItemSelect","explorer:item:select":"onItemSelect","explorer:item:select:all":"onItemSelect"},defaults:{loading:true,type:m.default.FROM_FILESEARCH,selected:0},getExplorer:function a(){return this.ids["b-explorer"]},onLoad:function a(){this.set({loading:false,selected:this.getExplorer().getSelectedCount()})},onItemSelect:function a(){this.set("selected",this.getExplorer().getSelectedCount())},onAttach:function a(){var b=this.getExplorer();var c=b.getSelectedFiles(),d=c.loaded,e=c.preset;var f=[];var g=[];var h=this.get("attachments");this.set("loading",true);h.forEach(function(a){if(e.find(function(b){return b===a.getFileSearchAttachId()})){return}if(!d.find(function(b){return b.id===a.getFileSearchAttachId()})){g.push(a)}});d.forEach(function(a){if(!h.find(function(b){return b.getFileSearchAttachId()===a.id})){f.push(a)}});this.resolveLayer("attach",{add:f,remove:g});this.broadcast("layer:hide")},onClose:function a(){this.resolveLayer("close");this.broadcast("layer:close")},onCancel:function a(){this.resolveLayer("cancel");this.broadcast("layer:hide")},resolveLayer:function a(b){var c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.broadcast("layer:resolve",{resolveData:p({type:b},c)})},_getSelectedText:function a(b){if(this.is("loading")){return""}var c=this.getExplorer();var d=!c.hasFreeSelectedCount();var e=c.getSelectedSize();var f=i18n.plural(b,[i18n("Выбрано {count} файлов",{count:b}),i18n("Выбран {count} файл",{count:b}),i18n("Выбрано {count} файла",{count:b})]);var g=i18n.plural(b,[i18n("Выбрано максимальное количество в {count} файлов",{count:b}),i18n("Выбрано максимальное количество в {count} файл",{count:b}),i18n("Выбрано максимальное количество в {count} файла",{count:b})]);return(d?g:f)+(" ("+(0,i.default)(e)+")")}})});define("feast-tpl!app/feast-tpl!ui-block/layer-cloud-create-folder/layer-cloud-create-folder.html",["feast"],function(a){return a.smartParse('\n<div qa:id="layer-cloud-create-folder">\n\t\x3c!-- Модификаторы --\x3e\n\t<bem:mod name="full"/>\n\n\t\x3c!-- Переменные --\x3e\n\t<fn:var name="fullPath" value="{_this.getPath()}"/>\n\n\t\x3c!-- Переход по табиндексам --\x3e\n\t<b:focus-zone>\n\t\t<fn:match name="content">\n\t\t\t\x3c!-- Лейер --\x3e\n\t\t\t<b:layer\n\t\t\t\tremit:close="close:click"\n\t\t\t\tcenter\n\t\t\t\tclose\n\t\t\t\terror="{attrs.error}"\n\t\t\t\tfooter\n\t\t\t\theader\n\t\t\t\tname="cloud-create-folder"\n\t\t\t\tprocessing="{attrs.processing}"\n\t\t\t\tstandard\n\t\t\t>\n\n\t\t\t\t<fn:match name="header" args="attrs">\n\t\t\t\t\t\x3c!-- Шапка лейера --\x3e\n\t\t\t\t\t<span>{i18n(\'Новая папка в\')} </span><span title="{fullPath}">«{fullPath}»</span>\n\t\t\t\t</fn:match>\n\n\t\t\t\t<fn:match name="content" args="attrs">\n\t\t\t\t\t\x3c!-- Содержимое: форма ввода --\x3e\n\t\t\t\t\t<form action="" remit:submit.prevent="submit:click">\n\t\t\t\t\t\t<b:input\n\t\t\t\t\t\t\tqa:id="name"\n\t\t\t\t\t\t\tremit:input-input="name:input"\n\t\t\t\t\t\t\tautoblur\n\t\t\t\t\t\t\tautofocus\n\t\t\t\t\t\t\terror="{attrs.error}"\n\t\t\t\t\t\t\tid="input"\n\t\t\t\t\t\t\tmaxlength="255"\n\t\t\t\t\t\t\tname="folder"\n\t\t\t\t\t\t\tplaceholder="{i18n(\'Название\')}"\n\t\t\t\t\t\t\ttab-index="{_this.tabIndex.INPUT}"\n\t\t\t\t\t\t\ttitle="{i18n(\'Название\')}"\n\t\t\t\t\t\t\ttype="input"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</form>\n\t\t\t\t</fn:match>\n\n\t\t\t\t<fn:match name="footer" args="attrs">\n\t\t\t\t\t\x3c!-- Футер с кнопками --\x3e\n\t\t\t\t\t<div bem:elem="submit-button">\n\t\t\t\t\t\t<b:button2\n\t\t\t\t\t\t\tremit:click="submit:click"\n\t\t\t\t\t\t\tqa:id="submit"\n\t\t\t\t\t\t\tdisabled="{attrs.processing}"\n\t\t\t\t\t\t\tfluid\n\t\t\t\t\t\t\tprimary\n\t\t\t\t\t\t\ttab-index="{_this.tabIndex.BUTTON_SUBMIT}"\n\t\t\t\t\t\t\ttext="{i18n(\'Создать папку\')}"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div bem:elem="cancel-button">\n\t\t\t\t\t\t<b:button2\n\t\t\t\t\t\t\tremit:click="close:click"\n\t\t\t\t\t\t\tevent:details="{close: true}"\n\t\t\t\t\t\t\tqa:id="cancel"\n\t\t\t\t\t\t\tdisabled="{attrs.processing}"\n\t\t\t\t\t\t\tfluid\n\t\t\t\t\t\t\ttab-index="{_this.tabIndex.BUTTON_CANCEL}"\n\t\t\t\t\t\t\ttext="{i18n(\'Отменить\')}"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</fn:match>\n\t\t\t</b:layer>\n\t\t</fn:match>\n\t</b:focus-zone>\n</div>\n',"app/feast-tpl!ui-block/layer-cloud-create-folder/layer-cloud-create-folder.html")});define("feast-tpl!ui-block/layer-cloud-create-folder/layer-cloud-create-folder.html",["feast-tpl!app/feast-tpl!ui-block/layer-cloud-create-folder/layer-cloud-create-folder.html"],function(a){return a});define("feast-tpl!app/feast-tpl!ui-block/focus-zone/focus-zone.html",["feast"],function(a){return a.smartParse('<div>\n\t<bem:mod name="fluid" test="attrs.fluid"/>\n\n\t<fn:apply-match name="content"/>\n</div>\n',"app/feast-tpl!ui-block/focus-zone/focus-zone.html")});define("feast-tpl!ui-block/focus-zone/focus-zone.html",["feast-tpl!app/feast-tpl!ui-block/focus-zone/focus-zone.html"],function(a){return a});define("ui-block/focus-zone/focus-zone",["exports","feast","feast-tpl!./focus-zone.html","service/smokescreen"],function(exports,a,b,c){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var d=f(a);var e=f(b);function f(a){return a&&a.__esModule?a:{default:a}}function g(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++){c[b]=a[b]}return c}else{return Array.from(a)}}exports.default=d.default.Block.extend({name:"focus-zone",template:e.default,isolateEvents:false,blocks:{},defaults:{enabled:true,fluid:false},attrChanged:{enabled:function a(b){this.toggleListener(b)}},didUnmount:function a(){this.toggleListener(false)},toggleListener:function a(b){this[b?"$on":"$off"](this.el.ownerDocument.defaultView,"keydown","onKeyDown")},onKeyDown:function a(b){if(b.keyCode!==9){return}b.preventDefault();var c=b.shiftKey;var d=this.queryFocusableElements();var e=document.activeElement;var f=d.indexOf(e);if(f===-1){f=0}if(c&&f<=0){f=d.length}else if(!c&&f>=d.length-1){f=-1}var g=d[f+(c?-1:1)];g&&g.focus&&g.focus()},queryFocusableElements:function a(){var b=[].concat(g(this.el.querySelectorAll((0,c.selector)("[tabindex]")))).filter(function(a){return a.tabIndex>0});b.sort(function(a,b){return a.tabIndex>b.tabIndex?1:-1});return b}})});define("feast-tpl!app/feast-tpl!ui-block/input/input.html",["feast"],function(a){return a.smartParse('<div>\n\t<bem:mod name="error" test="attrs.error"/>\n\n\t<input\n\t\tref="control"\n\t\tbem:elem="control"\n\t\tremit:input="input-input"\n\t\tremit:keydown.esc="input-escape"\n\t\tqa:id="input"\n\t\tplaceholder="{attrs.placeholder}"\n\t\ttype="{attrs.type}"\n\t\ttitle="{attrs.title}"\n\t\ttabindex="{attrs[\'tab-index\']}"\n\t\tvalue="{attrs.value}"\n\t>\n\t\t<fn:attr name="autocomplete" value="{attrs.autocomplete ? \'on\' : \'off\' }"/>\n\t\t<fn:attr name="autofocus" value="{true}" test="attrs.autofocus"/>\n\t\t<fn:attr name="maxlength" value="{attrs.maxlength}" test="attrs.maxlength"/>\n\t</input>\n\n\t<div bem:elem="error" fn:if="attrs.error">\n\t\t{attrs.error}\n\t</div>\n</div>\n\n',"app/feast-tpl!ui-block/input/input.html")});define("feast-tpl!ui-block/input/input.html",["feast-tpl!app/feast-tpl!ui-block/input/input.html"],function(a){return a});define("ui-block/input/input",["exports","feast","feast-tpl!./input.html"],function(exports,a,b){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var c=e(a);var d=e(b);function e(a){return a&&a.__esModule?a:{default:a}}exports.default=c.default.Block.extend({name:"input",template:d.default,blocks:{},defaults:{autoblur:false,autocomplete:false,autofocus:false,error:"",maxlength:null,placeholder:"","tab-index":0,title:"",type:"input"},events:{"input-escape":"onEscapePress"},didMount:function a(){var b=this;this.is("autofocus")&&window.setTimeout(function(){return b.focus()},10)},onEscapePress:function a(){this.is("autoblur")&&this.refs.control.blur()},getValue:function a(){return this.refs.control.value},setValue:function a(b){this.refs.control.value=b},focus:function a(){this.refs.control.focus()}})});define("ui-block/layer-cloud-create-folder/layer-cloud-create-folder",["exports","feast","feast-tpl!./layer-cloud-create-folder.html","mail/actions/CloudFolderAdd","ui-block/button2/button2","ui-block/focus-zone/focus-zone","ui-block/input/input","ui-block/layer/layer"],function(exports,a,b,c,d,e,f,g){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var h=o(a);var i=o(b);var j=o(c);var k=o(d);var l=o(e);var m=o(f);var n=o(g);function o(a){return a&&a.__esModule?a:{default:a}}var p=/\//g;exports.default=h.default.Block.extend({name:"layer-cloud-create-folder",template:i.default,isolate:true,isolateEvents:true,tabIndex:{INPUT:10,BUTTON_SUBMIT:20,BUTTON_CANCEL:30},strings:{exists:i18n("Такая папка уже существует"),invalid:i18n('В названии есть запрещённые символы: "*/:<>?|\\\\0'),name_too_long:i18n("Имя папки слишком длинное"),required:i18n("Укажите название папки"),unknown:i18n("Что-то пошло не так"),none:""},blocks:{button2:k.default,"focus-zone":l.default,input:m.default,layer:n.default},events:{"submit:click":"onSubmit","close:click":"onClose","name:input":"onNameInput"},defaults:{error:"",processing:false,parent:"/"},onNameInput:function a(){if(this.is("error")){this.set("error","")}},onSubmit:function a(){var b=this;if(this.is("processing")){return}var c=this.ids.input;var d=c.getValue();var e=d.trim().replace(p,"_");if(d!==e){c.setValue(e)}var f=this.get("parent");if(!e){this.showError("required");return}this.set("processing",true);j.default.execute({add:[{folder:f,name:e}]}).then(function(a){b.resolveLayer({type:"ok",name:a.result.get("body.0")})}).catch(function(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!a.error){b.showError("unknown",a);return}var c=a.error.get("body.home.error");b.showError(c)})},onClose:function a(){this.resolveLayer({type:"close"})},getPath:function a(){var b=this.get("parent");if(b[0]==="/"){b=b.slice(1)}return!b?i18n("Облаке"):b},showError:function a(b){var c=this.strings[b]||this.strings.unknown;if(c===this.strings.unknown){for(var d=arguments.length,e=Array(d>1?d-1:0),f=1;f<d;f++){e[f-1]=arguments[f]}console.error("layer-cloud-create-folder: ",e)}this.set({processing:false,error:c});this.ids.input.focus()},resolveLayer:function a(b){this.broadcast("layer:resolve",{resolveData:b,close:true})}})});define("cloud/actions/AcceptLicense",function(require){"use strict";var a=require("Action"),b=require("RPC");var c=a.extend({operation:function(){return new Promise(function(a,c){b.post("/api-proxy/cloud/v1/user/agree-la").then(function(b){b.isOK()?a():c()},c)})}});a.register("cloud.AcceptLicense",c);c.version="0.1.0";return c});define("feast-tpl!app/feast-tpl!ui-block/layer-cloud-license/layer-cloud-license.html",["feast"],function(a){return a.smartParse('<div qa:id="layer-cloud-license">\n\t<fn:var name="messages" value="{_this.getMessages()}"/>\n\n\t<b:layer name="cloud-license"\n\t\t\t remit:close="layer:close"\n\t\t\t close\n\t\t\t center\n\t\t\t header\n\t\t\t media\n\t\t\t standard>\n\n\t\t<fn:match name="header">\n\t\t\t<fn:value output="raw">messages.cloudPromoShort</fn:value>\n\t\t</fn:match>\n\n\t\t<fn:match name="content">\n\t\t\t<div bem:elem="row">\n\t\t\t\t<div bem:elem="column" bem:mod="left">\n\t\t\t\t\t<div bem:block="layer-cloud-license__image"/>\n\t\t\t\t</div>\n\n\t\t\t\t<div bem:elem="column" bem:mod="right">\n\t\t\t\t\t<div bem:elem="text">\n\t\t\t\t\t\t<fn:value output="raw">messages.cloudPromo</fn:value>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div bem:elem="text">\n\t\t\t\t\t\t<fn:value output="raw">messages.cloudSize</fn:value>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</fn:match>\n\n\t\t<fn:match name="footer">\n\t\t\t<b:button2\n\t\t\t\tqa:id="submit"\n\t\t\t\tremit:click="save"\n\t\t\t\ttext="{i18n(\'Создать Облако\')}"\n\t\t\t\tprimary\n\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t/>\n\n\t\t\t<div\n\t\t\t\tqa:id="annotation"\n\t\t\t\tbem:elem="footer-annotation"\n\t\t\t>\n\t\t\t\t{i18n(\'Нажимая на эту кнопку, вы принимаете условия\')} <b:link\n\t\t\t\t\tqa:id="link"\n\t\t\t\t\thref="https://cloud.mail.ru/LA/"\n\t\t\t\t\ttarget="_blank"\n\t\t\t\t\ttext="{i18n(\'Лицензионного соглашения\')}"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</fn:match>\n\t</b:layer>\n</div>\n',"app/feast-tpl!ui-block/layer-cloud-license/layer-cloud-license.html")});define("feast-tpl!ui-block/layer-cloud-license/layer-cloud-license.html",["feast-tpl!app/feast-tpl!ui-block/layer-cloud-license/layer-cloud-license.html"],function(a){return a});define("ui-block/layer-cloud-license/layer-cloud-license",["exports","cloud/actions/AcceptLicense","feast","feast-tpl!./layer-cloud-license.html","ui-block/button2/button2","ui-block/layer/layer"],function(exports,a,b,c,d,e){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var f=k(a);var g=k(b);var h=k(c);var i=k(d);var j=k(e);function k(a){return a&&a.__esModule?a:{default:a}}exports.default=g.default.Block.extend({name:"layer-cloud-license",template:h.default,blocks:{layer:j.default,button2:i.default},events:{save:"onSave"},onSave:function a(){var b=this;f.default.execute().then(function(){b.broadcast("layer:resolve",{close:true})})},getMessages:function a(){return{cloudPromoShort:i18n("Храните нужные файлы в Облаке,{br}чтобы они всегда были под рукой",{"unsafe-br":"<br/>"}),cloudPromo:i18n("{spanOpen}Облако Mail.ru{spanClose} {mdash} это ваш персональный диск в интернете.{br}Надёжное хранилище, доступное вам в любой точке мира с компьютера или телефона.",{"unsafe-spanOpen":"<strong>","unsafe-spanClose":"</strong>","unsafe-mdash":"&mdash;","unsafe-br":"<br/>"}),cloudSize:i18n("{spanOpen}Объём вашего облака {mdash} 8Гб.{spanClose}{br}Используйте его для хранения любых файлов, например: фото, видео, музыки, документов.",{"unsafe-spanOpen":"<strong>","unsafe-spanClose":"</strong>","unsafe-mdash":"&mdash;","unsafe-br":"<br/>"})}}})});define("feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-contacts/layer-explorer-from-contacts.html",["feast"],function(a){return a.smartParse('<div>\n\t<b:layer\n\t\tname="explorer"\n\t\tremit:close="close"\n\t\tclose\n\t\tstandard\n\t>\n\n\t\t<fn:match name="content">\n\t\t\t<b:explorer\n\t\t\t\tid="b-explorer"\n\t\t\t\ttype="{attrs.type}"\n\t\t\t\tslim="{attrs.slim}"\n\t\t\t\tfree-space="{attrs[\'free-space\']}"\n\t\t\t\tselect-limit="{attrs[\'select-limit\']}"\n\t\t\t\tcontacts="{attrs.contacts}"\n\t\t\t\tremit:loaded="explorer:loaded"\n\t\t\t\tremit:cache-scroll="explorer:scroll"\n\t\t\t\tremit:item-select="explorer:item:select"\n\t\t\t\tremit:item-select-all="explorer:item:select:all"\n\t\t\t/>\n\t\t</fn:match>\n\n\t\t<fn:match name="footer">\n\t\t\t<b:button2\n\t\t\t\tremit:click="attach"\n\t\t\t\ttext="{i18n(\'Добавить\')}"\n\t\t\t\tprimary\n\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\tsize="m"\n\t\t\t/>\n\t\t\t<b:button2\n\t\t\t\tremit:click="cancel"\n\t\t\t\ttext="{i18n(\'Отменить\')}"\n\t\t\t\tdisabled="{attrs.loading}"\n\t\t\t\tsize="m"\n\t\t\t/>\n\n\t\t\t<span class="layer-explorer__selected-files">\n\t\t\t\t{_this._getSelectedText(attrs.selected)}\n\t\t\t</span>\n\t\t</fn:match>\n\t</b:layer>\n</div>\n',"app/feast-tpl!ui-block/layer-explorer-from-contacts/layer-explorer-from-contacts.html")});define("feast-tpl!ui-block/layer-explorer-from-contacts/layer-explorer-from-contacts.html",["feast-tpl!app/feast-tpl!ui-block/layer-explorer-from-contacts/layer-explorer-from-contacts.html"],function(a){return a});define("ui-block/layer-explorer-from-contacts/layer-explorer-from-contacts",["exports","feast","feast-tpl!./layer-explorer-from-contacts.html","ui-block/button2/button2","ui-block/explorer/explorer","ui-block/explorer/explorer-types","ui-block/layer/layer"],function(exports,a,b,c,d,e,f){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var g=m(a);var h=m(b);var i=m(c);var j=m(d);var k=m(e);var l=m(f);function m(a){return a&&a.__esModule?a:{default:a}}var n=Object.assign||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.default=g.default.Block.extend({name:"layer-explorer-from-contacts",template:h.default,needToolkit:true,blocks:{button2:i.default,layer:l.default,explorer:j.default},events:{close:"onClose",cancel:"onCancel",attach:"onAdd","explorer:loaded":"onLoad","explorer:scroll":"onItemSelect","explorer:item:select":"onItemSelect","explorer:item:select:all":"onItemSelect"},defaults:{loading:true,type:k.default.FROM_CONTACTS,selected:0},getExplorer:function a(){return this.ids["b-explorer"]},onLoad:function a(){this.set({loading:false,selected:this.getExplorer().getSelectedCount()})},onItemSelect:function a(){this.set("selected",this.getExplorer().getSelectedCount())},onAdd:function a(){var b=this.getExplorer();var c=b.getSelectedContacts();var d=new Set(c.map(function(a){return a.get("emails")[0]}));var e=[];var f=[];var g=this.get("contacts");var h=new Set(g.map(function(a){return a.email}));this.set("loading",true);g.forEach(function(a){if(!d.has(a.email)){f.push(a)}});c.forEach(function(a){var b=a.get("emails")[0];if(!h.has(b)){e.push(a);h.add(b)}});e=e.map(function(a){var b=a.get("display_name")||a.get("nick")||"";b=b.trim();if(b===""&&a.get("name")){b=(a.get("name.last")||"")+(a.get("name.last")&&a.get("name.first")?" ":"")+(a.get("name.first")||"")}return{id:a.get("id"),name:b,email:a.get("emails")[0]}});this.resolveLayer("attach",{add:e,remove:f});this.broadcast("layer:hide")},onClose:function a(){this.resolveLayer("close");this.broadcast("layer:close")},onCancel:function a(){this.resolveLayer("cancel");this.broadcast("layer:hide")},resolveLayer:function a(b){var c=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.broadcast("layer:resolve",{resolveData:n({type:b},c)})},_getSelectedText:function a(b){if(this.is("loading")||b===0){return""}var c=this.getExplorer();var d=!c.hasFreeSelectedCount();var e=i18n("Выбрано: {count}",{count:b});var f=i18n.plural(b,[i18n("Выбрано максимальное количество в {count} контактов",{count:b}),i18n("Выбрано максимальное количество в {count} контакт",{count:b}),i18n("Выбрано максимальное количество в {count} контакта",{count:b})]);return d?f:e}})});